<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MALEVICH | Configurator V26 (Designer's Touch)</title>
    
    <script src="assets.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400..900;1,6..96,400..900&family=Tenor+Sans&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* --- STYLES --- */
        @font-face { font-family: 'Tenor Sans'; src: url('fonts/TenorSans.ttf') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
        @font-face { font-family: 'Bodoni Moda'; src: url('fonts/BodoniModa.ttf') format('truetype'); font-weight: 400 900; font-style: normal; font-display: swap; }

        :root { --bg-canvas: #e0e0e0; --bg-panel: #1a1a1a; --text-panel: #e5e5e5; --accent-gold: #D4AF37; --border-color: #333; --input-bg: #252525; --card-bg: #222; --card-hover: #2a2a2a; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Tenor Sans', sans-serif; background-color: var(--bg-canvas); height: 100vh; display: flex; color: #333; overflow: hidden; }

        /* LAYOUT */
        #workspace { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; background-color: var(--bg-canvas); background-image: linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px); background-size: 50px 50px; overflow: auto; }
        .canvas-container { box-shadow: 0 40px 100px rgba(0,0,0,0.4); border: none; background: #fff; margin: auto; }
        canvas.lower-canvas, canvas.upper-canvas { width: 100% !important; height: 100% !important; }
        #controls { width: 400px; background: var(--bg-panel); color: var(--text-panel); padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; box-shadow: -10px 0 30px rgba(0,0,0,0.2); z-index: 100; flex-shrink: 0; }

        /* TYPOGRAPHY */
        h1 { font-family: 'Bodoni Moda', serif; font-size: 24px; color: #fff; letter-spacing: 3px; margin-bottom: 10px; text-align: center; font-weight: 400; }
        h2 { font-family: 'Bodoni Moda', serif; font-size: 13px; color: var(--accent-gold); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 12px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-top: 5px; }
        label { display: block; margin-bottom: 8px; font-size: 10px; font-weight: bold; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        /* FORMAT & FONT SECTION */
        .format-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .format-card { flex: 1; border: 1px solid #444; background: var(--card-bg); cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; transition: all 0.2s; height: 60px; }
        .format-card:hover { border-color: #777; background: var(--card-hover); }
        .format-card.active { border-color: var(--accent-gold); background: #333; }
        .format-card span { font-size: 12px; color: #fff; }
        .format-card small { font-size: 9px; color: #888; margin-top: 2px; }

        /* LAYOUTS */
        .layout-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        .layout-card { aspect-ratio: 1; background: var(--card-bg); border: 1px solid #444; cursor: pointer; border-radius: 4px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; transition: all 0.2s; }
        .layout-card:hover { border-color: #777; background: var(--card-hover); }
        .layout-card.active { border-color: var(--accent-gold); box-shadow: 0 0 8px rgba(212, 175, 55, 0.2); }
        .layout-name { font-size: 9px; color: #777; margin-top: 5px; text-align: center; }
        
        /* Layout Miniatures */
        .mini-line { width: 60%; height: 2px; background: #666; border-radius: 2px; } .mini-line.short { width: 40%; }
        .mini-icon { width: 12px; height: 12px; border: 1px solid #777; border-radius: 50%; display: grid; place-items: center; }
        .mini-icon::after { content: '❤'; font-size: 8px; color: #777; line-height: 1; }
        .mini-photo { width: 70%; height: 50%; background: #333; border: 1px dashed #555; }
        .mini-art { width: 60%; height: 60%; border: 1px solid #777; border-radius: 50%; }
        .mini-mag { width: 100%; height: 100%; background: #333; border: 1px solid #444; display:flex; flex-direction:column; align-items:center; padding-top:4px; }
        .mini-mag-title { width: 80%; height: 3px; background: #fff; margin-bottom: 2px; }

        /* COLORS */
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
        .color-btn { width: 100%; aspect-ratio: 1; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; position: relative; }
        .color-btn:hover { transform: scale(1.1); z-index: 2; }
        .color-btn.active { border-color: #fff; transform: scale(1.15); box-shadow: 0 0 10px rgba(255,255,255,0.3); z-index: 2; }
        .color-btn.add-btn { border: 1px dashed #777; background: transparent; display: grid; place-items: center; color: #777; font-size: 20px; }
        .color-btn.add-btn:hover { border-color: var(--accent-gold); color: var(--accent-gold); }

        /* SLIDERS */
        input[type=range] { -webkit-appearance: none; width: 100%; height: 2px; background: #444; outline: none; margin-bottom: 15px; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; border-radius: 50%; background: var(--accent-gold); cursor: pointer; transition: transform 0.2s; border: 2px solid #222; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* INPUTS */
        .input-row-icon { display: flex; gap: 10px; align-items: stretch; margin-bottom: 15px; }
        .icon-trigger-btn { width: 46px; border: 1px solid #444; background: var(--input-bg); display: grid; place-items: center; cursor: pointer; transition: 0.3s; color: #555; font-size: 18px; }
        .icon-trigger-btn:hover { border-color: #777; color: #999; }
        .icon-trigger-btn.active { border-color: var(--accent-gold); } 
        select, input[type="text"] { font-family: 'Tenor Sans', sans-serif; width: 100%; padding: 12px; margin-bottom: 10px; background: var(--input-bg); border: 1px solid var(--border-color); color: #fff; border-radius: 2px; font-size: 14px; transition: border 0.3s; }
        select:focus, input:focus { border-color: var(--accent-gold); }
        button { background-color: #fff; color: #000; cursor: pointer; border: none; padding: 12px; font-weight: bold; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s; }
        button:hover { background-color: var(--accent-gold); color: #fff; }
        button.secondary { background: transparent; border: 1px solid #555; color: #ccc; }
        button.secondary:hover { border-color: #fff; color: #fff; background: transparent; }
        .btn-row { display: flex; gap: 10px; margin-bottom: 10px;} .btn-row button { flex: 1; }
        .slot-options { display: flex; gap: 5px; margin-bottom: 15px; }
        .slot-btn { flex: 1; padding: 10px; font-size: 11px; background: var(--input-bg); border: 1px solid var(--border-color); color: #888; }
        .slot-btn:hover { color: #fff; } .slot-btn.active { background: #fff; color: #000; border-color: #fff; }
        #saveBtn { margin-top: auto; background-color: var(--accent-gold); color: #fff; padding: 18px; font-size: 14px; }
        .hidden { display: none !important; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 30px; border-radius: 4px; border: 1px solid #333; width: 95%; max-width: 600px; display: flex; flex-direction: column; gap: 20px; max-height: 90vh; }
        .modal-header { font-family: 'Bodoni Moda', serif; color: #fff; text-align: center; font-size: 18px; position: relative; }
        .modal-close { position: absolute; right: 0; top: -5px; cursor: pointer; font-size: 20px; color: #777; } .modal-close:hover { color: #fff; }
        
        /* Color Gallery Styles */
        .gallery-tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .gallery-tab { padding: 8px 15px; font-size: 11px; color: #888; cursor: pointer; border: 1px solid transparent; white-space: nowrap; text-transform: uppercase; letter-spacing: 1px; }
        .gallery-tab.active { color: #fff; border: 1px solid var(--accent-gold); background: rgba(212, 175, 55, 0.1); }
        .palette-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 15px; padding: 15px 0; overflow-y: auto; max-height: 400px; }
        .palette-item { aspect-ratio: 1; border-radius: 50%; cursor: pointer; border: 2px solid transparent; position: relative; transition: transform 0.2s; }
        .palette-item:hover { transform: scale(1.1); z-index: 2; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .palette-item.active { border-color: #fff; transform: scale(1.15); }

        .crop-area-wrapper { background: #000; padding: 10px; display: flex; justify-content: center; }
        .zoom-controls { color: #fff; font-size: 12px; display: flex; align-items: center; gap: 15px; } input[type=range] { accent-color: var(--accent-gold); flex: 1; cursor: pointer; }

        /* LOADER */
        #app-loader { position: fixed; top:0; left:0; width:100%; height:100%; background: #1a1a1a; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; transition: opacity 0.8s ease; }
        .loader-text { font-family: 'Bodoni Moda', serif; font-size: 32px; letter-spacing: 5px; margin-bottom: 20px; animation: pulse 2s infinite; }
        .loader-sub { font-size: 10px; color: #555; letter-spacing: 2px; font-family: 'Tenor Sans'; text-transform: uppercase; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="app-loader">
        <div class="loader-text">MALEVICH</div>
        <div class="loader-sub">EST. 2025</div>
    </div>

    <div id="workspace">
        <canvas id="c"></canvas>
    </div>

    <div id="controls">
        <h1>MALEVICH</h1>
        
        <div class="section">
            <label>1. Формат и Шрифт</label>
            <div class="format-selector">
                <div class="format-card active" onclick="setBookSize(30, this)"><span>30x30</span><small>XL</small></div>
                <div class="format-card" onclick="setBookSize(25, this)"><span>25x25</span><small>L</small></div>
                <div class="format-card" onclick="setBookSize(20, this)"><span>20x20</span><small>M</small></div>
            </div>
            
            <select id="fontSelector">
                <option value="Tenor Sans">Tenor Sans (Гротеск)</option>
                <option value="Bodoni Moda">Bodoni Moda (Засечки)</option>
            </select>

            <label style="margin-top:10px; font-size:9px;">Размер Текста</label>
            <input type="range" id="mainScale" min="0.5" max="2.0" step="0.1" value="1.0">
        </div>

        <div class="section">
            <h2>2. Палитра</h2>
            <div id="coverColorGrid" class="color-grid">
                </div>
            <input type="color" id="customCoverPicker" style="visibility:hidden; position:absolute;">
            <input type="color" id="customTextPicker" style="visibility:hidden; position:absolute;">
        </div>

        <div class="section">
            <label>3. Дизайн Обложки</label>
            <div class="layout-grid">
                <div class="layout-card active" onclick="setLayout('icon', this)"><div class="mini-icon"></div><div class="layout-name">Символ</div></div>
                <div class="layout-card" onclick="setLayout('text_icon', this)"><div class="mini-line"></div><div class="mini-line short"></div><div class="mini-icon" style="margin-top:4px"></div><div class="layout-name">Текст+Символ</div></div>
                <div class="layout-card" onclick="setLayout('graphic', this)"><div class="mini-art"></div><div class="layout-name">Графика</div></div>
                <div class="layout-card" onclick="setLayout('text', this)"><div class="mini-line"></div><div class="mini-line"></div><div class="mini-line short"></div><div class="layout-name">Текст</div></div>
                <div class="layout-card" onclick="setLayout('photo_text', this)"><div class="mini-photo"></div><div class="mini-line short" style="margin-top:4px"></div><div class="layout-name">Фото+Текст</div></div>
                <div class="layout-card" onclick="setLayout('magazine', this)"><div class="mini-mag"><div class="mini-mag-title"></div></div><div class="layout-name">Журнал</div></div>
            </div>
        </div>

        <div class="section">
            <h2>4. Наполнение</h2>
            
            <div id="textContent">
                <input type="text" id="mainLine1" placeholder="Заголовок">
                <input type="text" id="mainLine2" placeholder="Подзаголовок">
                <input type="text" id="mainLine3" placeholder="Доп. строка">
                <label>Дата / Подпись (внизу)</label>
                <input type="text" id="dateLine" placeholder="2025">
            </div>

            <div id="iconSection" class="hidden" style="margin-top:15px;">
                <label>Выбор Иконки</label>
                <div class="btn-row">
                    <button onclick="openGallery('icons', 'main')">Галерея</button>
                    <button id="uploadIconBtn" class="secondary">Загрузить</button>
                </div>
                <input type="file" id="iconLoader" hidden accept="image/png">
            </div>

            <div id="imageSection" class="hidden" style="margin-top:15px;">
                <label id="imgSecTitle">Изображение</label>
                <div class="slot-options">
                    <button class="slot-btn active" onclick="setSlotSize(6,6)">1:1</button>
                    <button class="slot-btn" onclick="setSlotSize(5,9)">5:9</button>
                    <button class="slot-btn" onclick="setSlotSize(9,5)">9:5</button>
                </div>
                <div class="btn-row">
                    <button id="openGraphicGalleryBtn" onclick="openGallery('graphics', 'main')" class="hidden">Галерея</button>
                    <button id="uploadImageBtn">Загрузить</button>
                </div>
                <input type="file" id="imageLoader" hidden accept="image/*">
            </div>
        </div>
        
        <div class="section">
            <h2>5. Детали</h2>
            
            <label>Корешок (Иконка + Текст)</label>
            <div class="input-row-icon">
                <div id="spineIconBtn" class="icon-trigger-btn" onclick="openGallery('icons', 'spine')">❤</div>
                <input type="text" id="spineInput" placeholder="Текст на корешке..." style="margin-bottom:0;">
            </div>

            <label>Копирайт / QR</label>
            <div class="input-row-icon">
                <div id="qrBtn" class="icon-trigger-btn" style="font-size:12px; font-family:'Tenor Sans';" onclick="openQRModal()">QR</div>
                <input type="text" id="copyrightInput" value="DESIGN BY MALEVICH" placeholder="Копирайт..." style="margin-bottom:0;">
            </div>
        </div>

        <button id="saveBtn">СКАЧАТЬ PRINT-READY</button>
        <div id="debugInfo" style="font-size:9px; color:#555; text-align:center;"></div>
    </div>

    <div id="cropperModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">Кадрирование</div>
            <div class="crop-area-wrapper"><canvas id="cropCanvas"></canvas></div>
            <div class="zoom-controls"><span>ZOOM</span><input type="range" id="zoomSlider" min="0.1" max="4" step="0.01" value="1"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="secondary" id="cancelCropBtn" style="flex:1;">Отмена</button>
                <button id="applyCropBtn" style="flex:1; background:var(--accent-gold); color:#fff;">Применить</button>
            </div>
        </div>
    </div>

    <div id="galleryModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header"><span id="galleryTitle">Галерея</span><span class="modal-close" onclick="closeGallery()">×</span></div>
            <div class="gallery-tabs" id="galleryTabs"></div>
            <div class="gallery-grid" id="galleryGrid"></div>
        </div>
    </div>
    
    <div id="colorModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">Палитра Трендов<span class="modal-close" onclick="document.getElementById('colorModal').classList.add('hidden')">×</span></div>
            <div class="gallery-tabs" id="colorTabs"></div>
            <div class="palette-grid" id="paletteGrid"></div>
        </div>
    </div>

    <div id="qrModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">QR Код</div>
            <div style="color:#ccc; font-size:12px; text-align:center;">
                Введите ссылку (сайт, instagram).<br>QR-код будет цветом текста.
            </div>
            <input type="text" id="qrLinkInput" placeholder="https://..." value="https://">
            <div style="display:flex; gap:10px;">
                <button class="secondary" onclick="document.getElementById('qrModal').classList.add('hidden')" style="flex:1;">Отмена</button>
                <button onclick="applyQR()" style="flex:1; background:var(--accent-gold); color:#fff;">Добавить</button>
            </div>
            <div style="text-align:center;">
                <button class="secondary" onclick="removeQR()" style="border-color:#555; color:#777; font-size:10px; padding:8px;">Удалить QR</button>
            </div>
        </div>
    </div>

    <script>
        const EXPORT_DPI = 300, CM_TO_INCH = 2.54, SPINE_WIDTH_CM = 1.5, COPYRIGHT_TEXT = "DESIGN BY MALEVICH", RENDER_SCALE = 3.0;
        
        // --- DESIGNER PALETTES (Smart Contrast) ---
        const DESIGNER_PALETTES = {
            'Wedding Trends': [
                { hex: '#FDFBF7', text: '#3A3A3A', name: 'Bridal White' },
                { hex: '#F2E8E3', text: '#5D4037', name: 'Dusty Rose' },
                { hex: '#D8D0C5', text: '#2C3E50', name: 'Champagne' },
                { hex: '#BCC6CC', text: '#1A252F', name: 'Silver Blue' },
                { hex: '#EAE6DA', text: '#4A4036', name: 'Ivory Cream' },
                { hex: '#D1C4E9', text: '#4527A0', name: 'Lavender Mist' },
                { hex: '#C8E6C9', text: '#1B5E20', name: 'Sage Green' },
                { hex: '#FFF3E0', text: '#E65100', name: 'Peach Soft' }
            ],
            'Newborn Trends': [
                { hex: '#E0F7FA', text: '#006064', name: 'Baby Blue' },
                { hex: '#FCE4EC', text: '#880E4F', name: 'Soft Pink' },
                { hex: '#FFF9C4', text: '#F57F17', name: 'Buttercup' },
                { hex: '#F3E5F5', text: '#4A148C', name: 'Lilac' },
                { hex: '#E0F2F1', text: '#004D40', name: 'Mint' },
                { hex: '#FFF3E0', text: '#BF360C', name: 'Apricot' },
                { hex: '#ECEFF1', text: '#263238', name: 'Cloud' },
                { hex: '#FBE9E7', text: '#BF360C', name: 'Warm Skin' }
            ],
            'Pantone Trends': [
                { hex: '#FFBE98', text: '#4E342E', name: 'Peach Fuzz (2024)' },
                { hex: '#BB2649', text: '#FFFFFF', name: 'Viva Magenta (2023)' },
                { hex: '#6667AB', text: '#FFFFFF', name: 'Very Peri (2022)' },
                { hex: '#F5DF4D', text: '#939597', name: 'Illuminating (2021)' },
                { hex: '#939597', text: '#F5DF4D', name: 'Ultimate Gray (2021)' },
                { hex: '#0F4C81', text: '#FFFFFF', name: 'Classic Blue (2020)' },
                { hex: '#FF6F61', text: '#FFFFFF', name: 'Living Coral (2019)' },
                { hex: '#5F4B8B', text: '#FFFFFF', name: 'Ultra Violet (2018)' }
            ],
            'Avant-Garde': [
                { hex: '#FF0000', text: '#00FFFF', name: 'Pop Art Red' },
                { hex: '#FFFF00', text: '#000000', name: 'Warhol Yellow' },
                { hex: '#0000FF', text: '#FFFF00', name: 'Klein Blue' },
                { hex: '#000000', text: '#FFFFFF', name: 'Malevich Black' },
                { hex: '#FF00FF', text: '#00FF00', name: 'Neon Fuchsia' },
                { hex: '#00FF00', text: '#FF00FF', name: 'Acid Green' },
                { hex: '#FF6600', text: '#0000FF', name: 'Kusama Orange' },
                { hex: '#111111', text: '#FFD700', name: 'Gold & Black' }
            ]
        };

        // Main Panel 8 Colors (Trend Mix)
        const MAIN_PALETTE = [
            ...DESIGNER_PALETTES['Wedding Trends'].slice(0, 2),
            ...DESIGNER_PALETTES['Pantone Trends'].slice(0, 2),
            { hex: '#2C3E50', text: '#ECF0F1', name: 'Graphite' },
            { hex: '#5D4037', text: '#D7CCC8', name: 'Espresso' },
            { hex: '#FFFFFF', text: '#1a1a1a', name: 'Pure White' },
            { hex: '#1a1a1a', text: '#FFFFFF', name: 'Deep Black' }
        ];

        let state = {
            bookSize: 30, layout: 'icon', ppi: 10,
            slotSize: { w: 6, h: 6 },
            text: { 
                l1: "", l2: "", l3: "", date: "", spine: "", copyright: "DESIGN BY MALEVICH", 
                font: "Tenor Sans", color: "#1a1a1a",
                scaleMain: 1.0, scaleSec: 1.0 
            },
            coverColor: "#FFFFFF",
            images: { icon: null, main: null, spineIcon: null },
            qr: { enabled: false, url: "" },
            visualW: 0, visualH: 0
        };

        const canvas = new fabric.Canvas('c', { backgroundColor: '#fff', selection: false, enableRetinaScaling: false });
        let cropCanvas = null, tempImgObject = null, activeCropSlot = { w: 0, h: 0 };
        const CROP_CANVAS_SIZE = 500;

        function loadSimpleImage(path, callback) {
            const img = new Image();
            img.onload = () => callback(path);
            img.onerror = () => callback(null);
            img.src = path;
        }

        // --- INIT & COLORS ---
        function initColors() {
            renderMainPalette();
            // Init Color Modal
            const tabs = document.getElementById('colorTabs');
            Object.keys(DESIGNER_PALETTES).forEach((cat, i) => {
                const t = document.createElement('div'); t.className = `gallery-tab ${i===0?'active':''}`; t.innerText = cat;
                t.onclick = () => { document.querySelectorAll('#colorModal .gallery-tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); loadPalette(cat); };
                tabs.appendChild(t);
            });
            loadPalette('Wedding Trends');
        }

        function renderMainPalette() {
            const container = document.getElementById('coverColorGrid');
            container.innerHTML = '';
            MAIN_PALETTE.forEach((col, i) => {
                const btn = document.createElement('div');
                btn.className = `color-btn ${col.hex === state.coverColor ? 'active' : ''}`; 
                btn.style.backgroundColor = col.hex;
                if(col.hex.toUpperCase() === '#FFFFFF') btn.style.border = '1px solid #ccc';
                btn.onclick = () => applySmartColor(col);
                container.appendChild(btn);
            });
            // Add Button
            const addBtn = document.createElement('div'); addBtn.className = 'color-btn add-btn'; addBtn.innerHTML = '+';
            addBtn.onclick = () => document.getElementById('colorModal').classList.remove('hidden');
            container.appendChild(addBtn);
        }

        function loadPalette(cat) {
            const grid = document.getElementById('paletteGrid'); grid.innerHTML = '';
            DESIGNER_PALETTES[cat].forEach(col => {
                const item = document.createElement('div'); item.className = 'palette-item';
                item.style.backgroundColor = col.hex;
                if(col.hex.toUpperCase() === '#FFFFFF') item.style.border = '1px solid #ccc';
                item.onclick = () => { applySmartColor(col); document.getElementById('colorModal').classList.add('hidden'); renderMainPalette(); }; // Refresh main to show active if needed
                grid.appendChild(item);
            });
        }

        function applySmartColor(colData) {
            state.coverColor = colData.hex;
            state.text.color = colData.text; // Smart Contrast
            
            // Update UI
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            // Try to find if this color is in main palette
            const matchingBtn = Array.from(document.querySelectorAll('#coverColorGrid .color-btn')).find(b => {
                return b.style.backgroundColor && rgbToHex(b.style.backgroundColor).toUpperCase() === colData.hex.toUpperCase();
            });
            if(matchingBtn) matchingBtn.classList.add('active');

            // Update Text Color Buttons UI (Fake it, as we auto-selected)
            // No, actually we don't have text color buttons anymore in this compact view? 
            // Wait, we removed them from HTML? No, I should check my prompt.
            // "Сокращаем палитру до 8 трендовых...". I removed Text Color grid from HTML above to simplify. 
            // If user wants custom text color, they can't in this version? 
            // The prompt implied we provide "Smart Contrast". Let's assume auto is best. 
            // Or I can leave the Custom Picker hidden if they really need it.
            
            if(state.images.spineIcon) { document.getElementById('spineIconBtn').style.color = state.text.color; document.getElementById('spineIconBtn').style.borderColor = state.text.color; }
            if(state.qr.enabled) { document.getElementById('qrBtn').style.color = state.text.color; document.getElementById('qrBtn').style.borderColor = state.text.color; }
            
            renderLayout();
        }
        
        function rgbToHex(rgb) {
            if(!rgb) return '';
            rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            return "#" + ("0" + parseInt(rgb[1],10).toString(16)).slice(-2) + ("0" + parseInt(rgb[2],10).toString(16)).slice(-2) + ("0" + parseInt(rgb[3],10).toString(16)).slice(-2);
        }

        function loadDefaultAssets() {
            initColors();
            setTimeout(() => { document.getElementById('app-loader').style.opacity = '0'; setTimeout(() => document.getElementById('app-loader').style.display='none', 800); }, 1500);
            
            const relPath = 'icons/love/01heart.png';
            loadSimpleImage('assets/print/' + relPath, (url1) => {
                const final = url1 || ('assets/preview/' + relPath);
                state.images.icon = final; finishInit();
            });
        }

        function finishInit() { setLayout('icon', document.querySelector('.layout-card')); updateCanvasDimensions(); }

        // --- SPINE & QR ---
        window.openQRModal = () => { document.getElementById('qrModal').classList.remove('hidden'); }
        window.applyQR = () => {
            const url = document.getElementById('qrLinkInput').value;
            if(url.length > 3) {
                state.qr.enabled = true; state.qr.url = url;
                document.getElementById('qrBtn').classList.add('active');
                document.getElementById('qrBtn').style.borderColor = state.text.color;
                document.getElementById('qrBtn').style.color = state.text.color;
                renderLayout();
            }
            document.getElementById('qrModal').classList.add('hidden');
        }
        window.removeQR = () => {
            state.qr.enabled = false;
            document.getElementById('qrBtn').classList.remove('active');
            document.getElementById('qrBtn').style.borderColor = '#444';
            document.getElementById('qrBtn').style.color = '#555';
            renderLayout(); document.getElementById('qrModal').classList.add('hidden');
        }

        // --- UI ---
        window.setBookSize = (size, btn) => {
            state.bookSize = size;
            document.querySelectorAll('.format-card').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); updateCanvasDimensions();
        }

        window.setLayout = (layoutType, btn) => {
            state.layout = layoutType;
            document.querySelectorAll('.layout-card').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            ['iconSection','imageSection'].forEach(id => document.getElementById(id).classList.add('hidden'));
            const imgBtn = document.getElementById('uploadImageBtn');
            const graphicBtn = document.getElementById('openGraphicGalleryBtn');
            const imgTitle = document.getElementById('imgSecTitle');

            // Reset font if moving away from magazine
            if(state.layout === 'magazine' && layoutType !== 'magazine') {
                // Restore user font? Or default. Let's keep what's in selector.
                state.text.font = document.getElementById('fontSelector').value;
            }

            switch(layoutType) {
                case 'icon': document.getElementById('iconSection').classList.remove('hidden'); break;
                case 'text_icon': document.getElementById('iconSection').classList.remove('hidden'); break;
                case 'graphic': 
                    document.getElementById('imageSection').classList.remove('hidden'); imgTitle.innerText = "Графика";
                    imgBtn.classList.add('hidden'); graphicBtn.classList.remove('hidden'); break;
                case 'text': break;
                case 'photo_text': 
                    document.getElementById('imageSection').classList.remove('hidden');
                    imgTitle.innerText = "Фотография"; imgBtn.classList.remove('hidden'); graphicBtn.classList.add('hidden'); break;
                case 'magazine':
                    document.getElementById('imageSection').classList.remove('hidden');
                    imgTitle.innerText = "Фото обложки"; 
                    imgBtn.classList.remove('hidden'); graphicBtn.classList.add('hidden');
                    // Force Bodoni
                    state.text.font = 'Bodoni Moda';
                    // Update selector UI if possible, or just internal state
                    break;
            }
            renderLayout();
        }

        // --- RENDER ENGINE ---
        function updateCanvasDimensions() {
            const container = document.getElementById('workspace');
            const margin = 20; 
            const maxBookW = 30*2 + SPINE_WIDTH_CM; const maxBookH = 30;
            const basePPI = Math.max(5, Math.min((container.clientWidth - margin*2) / maxBookW, (container.clientHeight - margin*2) / maxBookH));
            state.ppi = basePPI * RENDER_SCALE;
            
            const curW = state.bookSize*2 + SPINE_WIDTH_CM; const curH = state.bookSize;
            canvas.setWidth(curW * state.ppi); canvas.setHeight(curH * state.ppi);
            canvas.wrapperEl.style.width = `${curW * basePPI}px`; canvas.wrapperEl.style.height = `${curH * basePPI}px`;
            canvas.lowerCanvasEl.style.width = '100%'; canvas.upperCanvasEl.style.width = '100%';
            canvas.lowerCanvasEl.style.height = '100%'; canvas.upperCanvasEl.style.height = '100%';
            renderLayout();
        }

        function renderLayout() {
            canvas.clear(); canvas.setBackgroundColor(state.coverColor);
            const h = canvas.height;
            const x1 = state.bookSize*state.ppi; const x2 = (state.bookSize+1.5)*state.ppi;
            const spineX = x1 + ((x2-x1)/2); const frontCenter = x2 + (state.bookSize*state.ppi/2);
            const backCenter = (state.bookSize*state.ppi)/2;

            const lineOpts = { stroke: '#e74c3c', strokeWidth: 2, strokeDashArray: [10,10], selectable: false, evented: false, opacity: 0.3 };
            canvas.add(new fabric.Line([x1,0,x1,h], lineOpts)); canvas.add(new fabric.Line([x2,0,x2,h], lineOpts));

            const bottomBase = h - (1.5 * state.ppi);

            // 1. SPINE
            if(state.images.spineIcon) {
                const size = 1.0 * state.ppi; // Fixed physical size (1cm)
                fabric.Image.fromURL(state.images.spineIcon, (img) => {
                    img.scaleToWidth(size);
                    img.set({ originX: 'center', originY: 'bottom', left: spineX, top: bottomBase, selectable: false });
                    const filter = new fabric.Image.filters.BlendColor({ color: state.text.color, mode: 'tint', alpha: 1 });
                    img.filters.push(filter); img.applyFilters();
                    canvas.add(img);
                });
            }

            if(state.text.spine) {
                let textBottom = bottomBase;
                if(state.images.spineIcon) textBottom -= (1.2 * state.ppi); 
                const spineTxt = new fabric.Text(state.text.spine, {
                    fontFamily: 'Tenor Sans', fontSize: 0.5 * state.ppi, fill: state.text.color,
                    originX: 'left', originY: 'center', left: spineX, top: textBottom, angle: -90, selectable: false
                });
                canvas.add(spineTxt);
            }

            // 2. BACK COVER
            if(state.layout === 'magazine') {
                // Magazine Back Photo
                if(state.images.main && state.images.main.src) {
                     fabric.Image.fromURL(state.images.main.src, (img) => {
                        // Full height cover, left side
                        const coverW = state.bookSize * state.ppi;
                        const scale = Math.max(coverW / img.width, h / img.height);
                        img.set({ scaleX: scale, scaleY: scale, left: backCenter, top: h/2, originX: 'center', originY: 'center', selectable: false });
                        img.clipPath = new fabric.Rect({ width: coverW/scale, height: h/scale, left: -coverW/2/scale, top: -h/2/scale });
                        canvas.add(img);
                        // Re-add lines on top? Or send back.
                        canvas.sendToBack(img);
                    });
                }
            }

            const copyTxt = new fabric.Text(state.text.copyright, {
                left: backCenter, top: bottomBase,
                fontSize: 0.35 * state.ppi, fontFamily: 'Tenor Sans', fill: state.text.color, opacity: 0.6, 
                originX: 'center', originY: 'bottom', selectable: false, letterSpacing: 50
            });
            canvas.add(copyTxt);

            if(state.qr.enabled && state.qr.url) {
                const qrSize = 1.2 * state.ppi;
                const qrObj = new QRious({ value: state.qr.url, size: 500, level: 'H', foreground: state.text.color, backgroundAlpha: 0 });
                fabric.Image.fromURL(qrObj.toDataURL(), (img) => {
                    img.scaleToWidth(qrSize);
                    img.set({
                        left: backCenter, 
                        top: bottomBase - (0.5 * state.ppi) - (0.35 * state.ppi) - (0.5*state.ppi),
                        originX: 'center', originY: 'bottom', selectable: false
                    });
                    canvas.add(img);
                });
            }

            // 3. FRONT COVER
            const cy = h/2;
            const gap = 2.0 * state.ppi;

            if(state.layout === 'magazine') {
                // Magazine Front Photo
                if(state.images.main && state.images.main.src) {
                     fabric.Image.fromURL(state.images.main.src, (img) => {
                        const coverW = state.bookSize * state.ppi;
                        const scale = Math.max(coverW / img.width, h / img.height);
                        // Front center is x2 + coverW/2
                        img.set({ scaleX: scale, scaleY: scale, left: frontCenter, top: h/2, originX: 'center', originY: 'center', selectable: false });
                        img.clipPath = new fabric.Rect({ width: coverW/scale, height: h/scale, left: -coverW/2/scale, top: -h/2/scale });
                        canvas.add(img);
                        canvas.sendToBack(img); // Background
                    });
                }
                // Magazine Text (Top)
                renderTextBlock(frontCenter, 2.0 * state.ppi, false, true); 
            }
            else if(state.layout === 'icon') { renderIcon(frontCenter, cy); } 
            else if(state.layout === 'text_icon') { renderTextBlock(frontCenter, cy - gap/1.5, true); renderIcon(frontCenter, cy + gap); } 
            else if(state.layout === 'graphic') { renderImageSlot(frontCenter, cy); } 
            else if(state.layout === 'text') { renderTextBlock(frontCenter, cy, false); } 
            else if(state.layout === 'photo_text') { renderImageSlot(frontCenter, cy - gap/2); renderTextBlock(frontCenter, cy + gap*1.5, true); }
            
            document.getElementById('debugInfo').innerText = `Print: ${state.bookSize}cm @ 300DPI`;
        }

        // --- SUB RENDERERS ---
        function renderTextBlock(x, y, compact, isMagazine = false) {
            let txt = [document.getElementById('mainLine1').value, document.getElementById('mainLine2').value, document.getElementById('mainLine3').value].filter(Boolean).join("\n");
            if(!txt && !document.getElementById('dateLine').value) return; if(!txt) txt = " ";
            
            let baseSize = compact ? 0.8 : 1.2;
            let fontFamily = state.text.font;
            
            if(isMagazine) {
                baseSize = 2.5; // Huge
                fontFamily = 'Bodoni Moda';
            }

            const tObj = new fabric.Text(txt, { 
                fontFamily: fontFamily, 
                fontSize: baseSize * state.ppi * state.text.scaleMain, 
                textAlign: 'center', lineHeight: 1.3, originX: 'center', originY: 'center', 
                left: x, top: y, fill: state.text.color, selectable: false 
            });
            canvas.add(tObj);
            
            const dateVal = document.getElementById('dateLine').value;
            if(dateVal && !isMagazine) { // No date on mag cover typically? Or very small.
                const off = compact ? (tObj.height/2 + 1.0*state.ppi) : (tObj.height/2 + 2.0*state.ppi);
                canvas.add(new fabric.Text(dateVal, { fontFamily: 'Tenor Sans', fontSize: 0.5 * state.ppi * state.text.scaleSec, fill: state.text.color, opacity: 0.8, originX: 'center', originY: 'top', left: x, top: y + off, selectable: false }));
            }
        }

        function renderIcon(x, y) {
            const size = 1*state.ppi;
            if(!state.images.icon) return; 
            fabric.Image.fromURL(state.images.icon, (img) => {
                if(!img) return; img.scaleToWidth(size);
                img.set({ left: x, top: y, originX: 'center', originY: 'center', selectable: false });
                const filter = new fabric.Image.filters.BlendColor({ color: state.text.color, mode: 'tint', alpha: 1 });
                img.filters.push(filter); img.applyFilters();
                canvas.add(img);
            });
        }

        function renderImageSlot(x, y) {
            const w = state.slotSize.w * state.ppi; const h = state.slotSize.h * state.ppi;
            if(state.images.main && state.images.main.src) {
                fabric.Image.fromURL(state.images.main.src, (img) => {
                    const info = state.images.main.cropInfo; const scaleFactor = w / info.slotPixelSize;
                    img.set({ scaleX: info.scale * scaleFactor, scaleY: info.scale * scaleFactor, left: x + (info.left * scaleFactor), top: y + (info.top * scaleFactor), originX: 'center', originY: 'center', selectable: false, clipPath: new fabric.Rect({ width: w * (1/(info.scale * scaleFactor)), height: h * (1/(info.scale * scaleFactor)), left: -(info.left * scaleFactor) / (info.scale * scaleFactor), top: -(info.top * scaleFactor) / (info.scale * scaleFactor), originX: 'center', originY: 'center' }) });
                    if (state.layout === 'graphic') { const filter = new fabric.Image.filters.BlendColor({ color: state.text.color, mode: 'tint', alpha: 1 }); img.filters.push(filter); img.applyFilters(); }
                    canvas.add(img);
                });
            } else {
                const rect = new fabric.Rect({ width: w, height: h, fill: 'transparent', stroke: '#ddd', strokeWidth:2, strokeDashArray: [20,20], left: x, top: y, originX: 'center', originY: 'center', selectable: false });
                canvas.add(rect); canvas.add(new fabric.Text(state.layout === 'graphic' ? "ART" : "PHOTO", { fontSize: 0.3*state.ppi, fontFamily:'Tenor Sans', left: x, top: y, originX: 'center', originY: 'center', fill: '#bbb', selectable: false }));
            }
        }

        // --- HANDLERS ---
        ['mainLine1','mainLine2','mainLine3','dateLine', 'spineInput', 'copyrightInput'].forEach(id => {
            document.getElementById(id).oninput = (e) => {
                if(id === 'copyrightInput') state.text.copyright = e.target.value;
                else if(id === 'spineInput') state.text.spine = e.target.value;
                renderLayout();
            };
        });
        document.getElementById('fontSelector').addEventListener('change', (e) => { state.text.font = e.target.value; renderLayout(); });
        document.getElementById('mainScale').oninput = (e) => { state.text.scaleMain = parseFloat(e.target.value); renderLayout(); };

        document.getElementById('uploadIconBtn').onclick = () => document.getElementById('iconLoader').click();
        document.getElementById('iconLoader').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => { state.images.icon = ev.target.result; renderLayout(); }; if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); };
        document.getElementById('uploadImageBtn').onclick = () => document.getElementById('imageLoader').click();
        document.getElementById('imageLoader').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => openCropper(ev.target.result); if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); e.target.value = ''; };

        // Gallery
        let curGalTarget = 'main'; 
        window.openGallery = (type, target) => {
            curGalTarget = target;
            document.getElementById('galleryModal').classList.remove('hidden');
            const tabs = document.getElementById('galleryTabs'); tabs.innerHTML = '';
            const db = type === 'icons' ? ASSETS_DB.icons : ASSETS_DB.graphics;
            Object.keys(db).forEach((cat, i) => {
                const t = document.createElement('div'); t.className = `gallery-tab ${i===0?'active':''}`; t.innerText = cat;
                t.onclick = () => { document.querySelectorAll('.gallery-tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); loadGal(type, cat); };
                tabs.appendChild(t);
            });
            if(Object.keys(db).length) loadGal(type, Object.keys(db)[0]);
        }
        
        function loadGal(type, cat) {
            const grid = document.getElementById('galleryGrid');
            const files = (type === 'icons' ? ASSETS_DB.icons : ASSETS_DB.graphics)[cat] || [];
            grid.innerHTML = '';
            for(let f of files) {
                const item = document.createElement('div'); item.className = 'gallery-item';
                const img = document.createElement('img');
                const relPath = `${type}/${cat.toLowerCase()}/${f}`;
                const previewUrl = 'assets/preview/' + relPath;
                const printUrl = 'assets/print/' + relPath;
                img.src = previewUrl; img.onerror = () => { img.src = printUrl; };
                item.appendChild(img);
                item.onclick = () => {
                    loadSimpleImage(printUrl, (url1) => {
                        let finalUrl = url1 || previewUrl;
                        document.getElementById('galleryModal').classList.add('hidden'); 
                        
                        // FIX: Logic for Spine selection
                        if(curGalTarget === 'spine') {
                            state.images.spineIcon = finalUrl;
                            const btn = document.getElementById('spineIconBtn');
                            btn.classList.add('active');
                            btn.style.color = state.text.color; btn.style.borderColor = state.text.color;
                            renderLayout();
                        } else {
                            if(type==='icons') { state.images.icon = finalUrl; renderLayout(); } 
                            else openCropper(finalUrl); 
                        }
                    });
                };
                grid.appendChild(item);
            }
        }
        window.closeGallery = () => document.getElementById('galleryModal').classList.add('hidden');

        function initCrop() { if(!cropCanvas) { cropCanvas = new fabric.Canvas('cropCanvas', { width: CROP_CANVAS_SIZE, height: CROP_CANVAS_SIZE, backgroundColor: '#111', selection: false }); } cropCanvas.clear(); cropCanvas.setBackgroundColor('#111'); }
        function openCropper(url) {
            document.getElementById('cropperModal').classList.remove('hidden'); initCrop();
            const aspect = state.slotSize.w / state.slotSize.h;
            let slotPW, slotPH; if(aspect >= 1) { slotPW = CROP_CANVAS_SIZE*0.8; slotPH = slotPW/aspect; } else { slotPH = CROP_CANVAS_SIZE*0.8; slotPW = slotPH*aspect; }
            activeCropSlot = { w: slotPW, h: slotPH };
            fabric.Image.fromURL(url, (img) => {
                tempImgObject = img;
                const scale = Math.max(slotPW/img.width, slotPH/img.height);
                img.set({ left: CROP_CANVAS_SIZE/2, top: CROP_CANVAS_SIZE/2, originX: 'center', originY: 'center', scaleX: scale, scaleY: scale, hasControls: false, hasBorders: false });
                cropCanvas.add(img);
                const cx = CROP_CANVAS_SIZE/2, cy = CROP_CANVAS_SIZE/2;
                const overlay = new fabric.Path(`M 0 0 H ${CROP_CANVAS_SIZE} V ${CROP_CANVAS_SIZE} H 0 Z M ${cx-slotPW/2} ${cy-slotPH/2} H ${cx+slotPW/2} V ${cy+slotPH/2} H ${cx-slotPW/2} Z`, { fill: 'rgba(0,0,0,0.8)', selectable: false, evented: false });
                cropCanvas.add(overlay);
                const border = new fabric.Rect({ left: cx, top: cy, width: slotPW, height: slotPH, fill: 'transparent', stroke: '#fff', strokeWidth: 1, originX: 'center', originY: 'center', selectable: false, evented: false });
                cropCanvas.add(border);
                const slider = document.getElementById('zoomSlider'); slider.min = scale*0.5; slider.max = scale*4; slider.value = scale;
                slider.oninput = function() { img.scale(parseFloat(this.value)); cropCanvas.requestRenderAll(); };
            });
        }
        document.getElementById('applyCropBtn').onclick = () => {
            if(!tempImgObject) return;
            const offX = tempImgObject.left - CROP_CANVAS_SIZE/2; const offY = tempImgObject.top - CROP_CANVAS_SIZE/2;
            state.images.main = { src: tempImgObject.getSrc(), cropInfo: { left: offX, top: offY, scale: tempImgObject.scaleX, slotPixelSize: activeCropSlot.w } };
            renderLayout(); document.getElementById('cropperModal').classList.add('hidden');
        };
        document.getElementById('cancelCropBtn').onclick = () => document.getElementById('cropperModal').classList.add('hidden');

        document.getElementById('saveBtn').onclick = () => {
            try {
                const mult = (EXPORT_DPI / CM_TO_INCH) / state.ppi;
                canvas.getObjects('line').forEach(o => o.opacity = 0);
                const data = canvas.toDataURL({ format: 'png', multiplier: mult, quality: 1 });
                canvas.getObjects('line').forEach(o => o.opacity = 0.3);
                const a = document.createElement('a'); a.download = `cover_${state.bookSize}cm.png`; a.href = data; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            } catch(e) { alert("Ошибка сохранения: Браузер блокирует доступ (CORS)."); }
        };

        window.onload = loadDefaultAssets;
        window.addEventListener('resize', () => setTimeout(updateCanvasDimensions, 100));
    </script>
</body>
</html>