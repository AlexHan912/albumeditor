<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MALEVICH | Configurator V45 (Smart Spine)</title>
    
    <script src="assets.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400..900;1,6..96,400..900&family=Tenor+Sans&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* --- STYLES --- */
        @font-face { font-family: 'Tenor Sans'; src: url('fonts/TenorSans.ttf') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
        @font-face { font-family: 'Bodoni Moda'; src: url('fonts/BodoniModa.ttf') format('truetype'); font-weight: 400 900; font-style: normal; font-display: swap; }

        :root { --bg-canvas: #e0e0e0; --bg-panel: #1a1a1a; --text-panel: #e5e5e5; --accent-gold: #D4AF37; --border-color: #333; --input-bg: #252525; --card-bg: #222; --card-hover: #2a2a2a; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Tenor Sans', sans-serif; background-color: var(--bg-canvas); height: 100vh; display: flex; color: #333; overflow: hidden; }

        /* LAYOUT */
        #workspace { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; background-color: var(--bg-canvas); background-image: linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px); background-size: 50px 50px; overflow: auto; }
        .canvas-container { box-shadow: 0 40px 100px rgba(0,0,0,0.4); border: none; background: #fff; margin: auto; }
        canvas.lower-canvas, canvas.upper-canvas { width: 100% !important; height: 100% !important; }
        #controls { width: 400px; background: var(--bg-panel); color: var(--text-panel); padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 30px; box-shadow: -10px 0 30px rgba(0,0,0,0.2); z-index: 100; flex-shrink: 0; }

        /* TRIGGER BUTTON */
        #photoTrigger {
            position: absolute; width: 50px; height: 50px;
            background: rgba(255,255,255,0.9); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: #333; font-size: 24px; cursor: pointer;
            box-shadow: 0 0 0 0 rgba(255,255,255, 0.7);
            animation: pulse-white 2s infinite;
            z-index: 10; pointer-events: auto; transition: transform 0.2s;
        }
        #photoTrigger:hover { transform: scale(1.1); background: #fff; }
        #photoTrigger::after { content: '+'; }
        @keyframes pulse-white { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }

        /* TYPOGRAPHY */
        h1 { font-family: 'Bodoni Moda', serif; font-size: 24px; color: #fff; letter-spacing: 3px; margin-bottom: 10px; text-align: center; font-weight: 400; }
        h2 { font-family: 'Bodoni Moda', serif; font-size: 13px; color: var(--accent-gold); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 12px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-top: 5px; }
        label { display: block; margin-bottom: 8px; font-size: 10px; font-weight: bold; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        /* FORMATS */
        .format-selector { display: flex; gap: 10px; justify-content: flex-start; align-items: flex-end; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #333; overflow-x: auto; padding-top: 5px; }
        .format-card { border: 1px solid #444; background: var(--card-bg); cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all 0.2s; position: relative; flex-shrink: 0; }
        .format-card:hover { border-color: #777; background: var(--card-hover); }
        .format-card.active { border-color: var(--accent-gold); box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); background: #333; transform: translateY(-2px); }
        .format-card span { font-size: 10px; color: #aaa; pointer-events: none; }
        .f-30 { width: 60px; height: 60px; } .f-25 { width: 50px; height: 50px; } .f-20 { width: 40px; height: 40px; }

        /* CONTROLS */
        .typo-row { display: flex; gap: 15px; align-items: center; } .typo-col { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .scale-control { display: flex; justify-content: space-between; align-items: center; background: var(--input-bg); border: 1px solid var(--border-color); height: 38px; padding: 0 10px; border-radius: 2px; }
        .scale-label { font-size: 10px; color: #777; cursor: pointer; font-weight: bold; } .scale-label:hover { color: #ccc; }
        .scale-track { flex-grow: 1; margin: 0 10px; height: 2px; background: #444; position: relative; }
        input[type=range].scale-slider { -webkit-appearance: none; width: 100%; height: 2px; background: transparent; outline: none; margin: 0; cursor: pointer; position: absolute; top: 0; }
        input[type=range].scale-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: var(--accent-gold); border: 2px solid #222; cursor: pointer; margin-top: -5px; }

        /* COLORS */
        .palette-selector { width: 100%; margin-bottom: 15px; }
        .pairs-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 15px; }
        .pair-btn { width: 100%; aspect-ratio: 1; border-radius: 50%; cursor: pointer; border: 1px solid transparent; position: relative; transition: transform 0.2s; }
        .pair-btn:hover { transform: scale(1.1); z-index: 2; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .pair-btn.active { border-color: #fff; transform: scale(1.15); box-shadow: 0 0 10px rgba(255,255,255,0.4); z-index: 2; }
        .pair-heart { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; line-height: 1; }

        /* LAYOUTS */
        .layout-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        .layout-card { aspect-ratio: 1; background: var(--card-bg); border: 1px solid #444; cursor: pointer; border-radius: 4px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; overflow: hidden; }
        .layout-card:hover { border-color: #777; background: var(--card-hover); }
        .layout-card.active { border-color: var(--accent-gold); box-shadow: 0 0 8px rgba(212, 175, 55, 0.2); }
        .layout-name { font-size: 9px; color: #777; margin-top: 2px; text-align: center; }
        .mini-group { display: flex; flex-direction: column; align-items: center; gap: 4px; width: 100%; }
        .mini-line { width: 50%; height: 1px; background: #666; } .mini-line.short { width: 30%; }
        .mini-icon { font-size: 10px; color: #777; line-height: 1; }
        .mini-dashed-circle { width: 30px; height: 30px; border: 1px dashed #666; border-radius: 50%; display: grid; place-items: center; margin: 2px 0; }
        .mini-dashed-circle::after { content: '+'; color: #666; font-size: 12px; }
        .mini-dashed-rect { width: 36px; height: 24px; border: 1px dashed #666; display: grid; place-items: center; margin: 2px 0; }
        .mini-dashed-rect::after { content: '+'; color: #666; font-size: 12px; }
        .mini-mag-container { width: 100%; height: 100%; background: #333; display: flex; flex-direction: column; align-items: center; padding-top: 8px; }
        .mini-mag-title { width: 70%; height: 2px; background: #fff; margin-bottom: 2px; }

        /* TEXT BUILDER */
        .text-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: stretch; height: 38px; }
        .text-row input { margin-bottom: 0; flex-grow: 1; height: 100%; }
        .tool-btn { width: 38px; min-width: 38px; height: 100%; border: 1px solid #444; background: var(--input-bg); color: #777; display: grid; place-items: center; cursor: pointer; transition: 0.2s; font-family: 'Tenor Sans'; font-size: 12px; }
        .tool-btn:hover { border-color: #777; color: #fff; background: #333; }
        .tool-btn.active { border-color: var(--accent-gold); color: var(--accent-gold); background: #222; }
        .tool-btn.red:hover { border-color: #962f2f; color: #962f2f; }

        /* SPINE TOGGLES */
        .spine-controls { display: flex; gap: 5px; margin-bottom: 15px; }
        .spine-btn { flex: 1; border: 1px solid #444; background: var(--input-bg); color: #777; padding: 10px 5px; cursor: pointer; font-size: 10px; text-transform: uppercase; text-align: center; transition: 0.2s; }
        .spine-btn:hover { color: #ccc; border-color: #666; }
        .spine-btn.active { border-color: var(--accent-gold); color: #fff; background: #222; }

        /* INPUTS */
        .input-row-icon { display: flex; gap: 10px; align-items: stretch; margin-bottom: 15px; height: 38px; }
        .icon-trigger-btn { width: 46px; border: 1px solid #444; background: var(--input-bg); display: grid; place-items: center; cursor: pointer; transition: 0.3s; color: #555; font-size: 18px; background-size: 60%; background-position: center; background-repeat: no-repeat; flex-shrink: 0; height: 100%; }
        .icon-trigger-btn:hover { border-color: #777; color: #999; } .icon-trigger-btn.active { border-color: var(--accent-gold); } 
        @keyframes glow { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); border-color: #777; } 50% { box-shadow: 0 0 10px 0 rgba(212, 175, 55, 0.8); border-color: var(--accent-gold); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); border-color: #777; } }
        .pulse-attention { animation: glow 2s infinite; }
        select, input[type="text"] { font-family: 'Tenor Sans', sans-serif; width: 100%; padding: 0 12px; margin-bottom: 15px; background: var(--input-bg); border: 1px solid var(--border-color); color: #fff; border-radius: 2px; font-size: 14px; transition: border 0.3s; height: 38px; line-height: 38px;}
        select:focus, input:focus { border-color: var(--accent-gold); }
        button { background-color: #fff; color: #000; cursor: pointer; border: none; padding: 12px; font-weight: bold; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s; }
        button:hover { background-color: var(--accent-gold); color: #fff; }
        button.secondary { background: transparent; border: 1px solid #555; color: #ccc; }
        button.secondary:hover { border-color: #fff; color: #fff; background: transparent; }
        .hidden { display: none !important; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 30px; border-radius: 4px; border: 1px solid #333; width: 95%; max-width: 600px; display: flex; flex-direction: column; gap: 20px; max-height: 90vh; position: relative; }
        .modal-header { font-family: 'Bodoni Moda', serif; color: #fff; text-align: center; font-size: 18px; position: relative; }
        .modal-close { position: absolute; right: 0; top: -5px; cursor: pointer; font-size: 20px; color: #777; } .modal-close:hover { color: #fff; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 15px; overflow-y: auto; padding: 10px; min-height: 200px; }
        .gallery-item { aspect-ratio: 1; border: 1px solid #333; background: #222; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s; padding: 10px; }
        .gallery-item img { max-width: 100%; max-height: 100%; object-fit: contain; filter: grayscale(1); pointer-events: none; }
        .gallery-item:hover { border-color: var(--accent-gold); background: #2a2a2a; } .gallery-item:hover img { filter: grayscale(0); transform: scale(1.1); }
        .gallery-tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .gallery-tab { padding: 8px 15px; font-size: 11px; color: #888; cursor: pointer; border: 1px solid transparent; white-space: nowrap; }
        .gallery-tab.active { color: #fff; border: 1px solid var(--accent-gold); background: rgba(212, 175, 55, 0.1); }
        
        .crop-controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .crop-btn { padding: 5px 10px; font-size: 10px; background: #333; border: 1px solid #555; color: #ccc; cursor: pointer; }
        .crop-btn:hover { color: #fff; border-color: #fff; }
        .crop-area-wrapper { background: #000; padding: 10px; display: flex; justify-content: center; }
        .zoom-controls { color: #fff; font-size: 12px; display: flex; align-items: center; gap: 15px; } 

        /* LOADER */
        #app-loader { position: fixed; top:0; left:0; width:100%; height:100%; background: #1a1a1a; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; transition: opacity 0.8s ease; }
        .loader-text { font-family: 'Bodoni Moda', serif; font-size: 32px; letter-spacing: 5px; margin-bottom: 20px; animation: pulse 2s infinite; }
        .loader-sub { font-size: 10px; color: #555; letter-spacing: 2px; font-family: 'Tenor Sans'; text-transform: uppercase; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="app-loader">
        <div class="loader-text">MALEVICH</div>
        <div class="loader-sub">EST. 2025</div>
    </div>

    <div id="workspace">
        <canvas id="c"></canvas>
        <div id="photoTrigger" class="hidden" onclick="triggerAssetLoader()"></div>
    </div>

    <div id="controls">
        <h1>MALEVICH</h1>
        
        <div class="section">
            <h2>1. Название Книги</h2>
            <div id="textBuilder">
                <div class="text-row" id="row1">
                    <input type="text" id="inputLine1" placeholder="THE VISUAL DIARY">
                    <div class="tool-btn" onclick="toggleCase(1)" id="btnTt1">Tt</div>
                    <div class="tool-btn" onclick="showRow(2)">+</div>
                </div>
                <div class="text-row hidden" id="row2">
                    <input type="text" id="inputLine2" placeholder="Доп. строка">
                    <div class="tool-btn" onclick="toggleCase(2)" id="btnTt2">Tt</div>
                    <div class="tool-btn" onclick="showRow(3)">+</div>
                    <div class="tool-btn red" onclick="hideRow(2)">×</div>
                </div>
                <div class="text-row hidden" id="row3">
                    <input type="text" id="inputLine3" placeholder="Доп. строка">
                    <div class="tool-btn" onclick="toggleCase(3)" id="btnTt3">Tt</div>
                    <div class="tool-btn red" onclick="hideRow(3)">×</div>
                </div>
                <label style="margin-top:10px;">Символ и Дата</label>
                <div class="input-row-icon">
                    <div id="globalSymbolBtn" class="icon-trigger-btn pulse-attention" onclick="openGallery('icons', 'global')"></div>
                    <input type="text" id="dateLine" placeholder="2025 / Подпись" style="margin-bottom:0;">
                </div>
            </div>
            <input type="file" id="imageLoader" hidden accept="image/*">
            <input type="file" id="iconLoader" hidden accept="image/png">
        </div>

        <div class="section">
            <label>2. Размер книги и шрифт</label>
            <div class="format-selector">
                <div class="format-card f-30 active" onclick="setBookSize(30, this)"><span>30x30</span></div>
                <div class="format-card f-25" onclick="setBookSize(25, this)"><span>25x25</span></div>
                <div class="format-card f-20" onclick="setBookSize(20, this)"><span>20x20</span></div>
            </div>
            <div class="typo-row">
                <div class="typo-col">
                    <select id="fontSelector" style="margin:0;">
                        <option value="Tenor Sans">Tenor Sans</option>
                        <option value="Bodoni Moda">Bodoni Moda</option>
                    </select>
                </div>
                <div class="typo-col">
                    <div class="scale-control">
                        <span class="scale-label" onclick="setScale(0.8, this)">S</span>
                        <div class="scale-track">
                            <input type="range" class="scale-slider" id="textScale" min="1" max="4" step="1" value="2" oninput="updateScaleFromSlider(this.value)">
                        </div>
                        <span class="scale-label" onclick="setScale(1.6, this)">XL</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>3. Материалы</h2>
            <select id="paletteSelector" class="palette-selector" onchange="changeCollection(this.value)">
                <option value="Wedding Trends">Wedding Trends</option>
                <option value="New Born">New Born Trends</option>
                <option value="Pantone Trends">Pantone Trends</option>
                <option value="Kinfolk - Cinema">Kinfolk - Cinema</option>
                <option value="Fashion Magazine">Fashion Magazine</option>
                <option value="Avant-Garde">Yayoi Kusama Avant-Garde</option>
                <option value="Custom">Выбрать свои цвета...</option>
            </select>
            <div id="pairsGrid" class="pairs-grid"></div>
            <div id="customPickers" class="hidden">
                <label>Цвет Обложки</label>
                <input type="color" id="customCoverPicker" value="#FFFFFF">
                <label>Цвет Элементов</label>
                <input type="color" id="customTextPicker" value="#1a1a1a">
            </div>
        </div>

        <div class="section">
            <h2>4. Дизайн Обложки</h2>
            <div class="layout-grid">
                <div class="layout-card" onclick="setLayout('icon', this)">
                    <div class="mini-icon">❤</div>
                    <div class="layout-name">Символ</div>
                </div>
                <div class="layout-card active" onclick="setLayout('text_icon', this)">
                    <div class="mini-group">
                        <div class="mini-line"></div>
                        <div class="mini-line short"></div>
                    </div>
                    <div class="mini-icon" style="margin-top:2px">❤</div>
                    <div class="layout-name">Текст+Символ</div>
                </div>
                <div class="layout-card" onclick="setLayout('graphic', this)">
                    <div class="mini-dashed-circle"></div>
                    <div class="layout-name">Графика</div>
                </div>
                <div class="layout-card" onclick="setLayout('text', this)">
                    <div class="mini-group" style="gap:6px">
                        <div class="mini-line"></div>
                        <div class="mini-line"></div>
                        <div class="mini-line short"></div>
                    </div>
                    <div class="layout-name">Текст</div>
                </div>
                <div class="layout-card" onclick="setLayout('photo_text', this)">
                    <div class="mini-dashed-rect"></div>
                    <div class="mini-line short" style="margin-top:4px"></div>
                    <div class="layout-name">Фото+Текст</div>
                </div>
                <div class="layout-card" onclick="setLayout('magazine', this)">
                    <div class="mini-mag-container">
                        <div class="mini-mag-title"></div>
                    </div>
                    <div class="layout-name">Журнал</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>5. Детали</h2>
            <label>Корешок (Элементы)</label>
            <div class="spine-controls">
                <div id="btnSpineSymbol" class="spine-btn active" onclick="toggleSpinePart('symbol')">❤</div>
                <div id="btnSpineTitle" class="spine-btn" onclick="toggleSpinePart('title')">Название</div>
                <div id="btnSpineDate" class="spine-btn" onclick="toggleSpinePart('date')">Дата</div>
            </div>

            <label>Копирайт / QR</label>
            <div class="input-row-icon">
                <div id="qrBtn" class="icon-trigger-btn" style="font-size:12px; font-family:'Tenor Sans';" onclick="openQRModal()">QR</div>
                <input type="text" id="copyrightInput" value="" placeholder="Photo by..." style="margin-bottom:0;">
            </div>
        </div>

        <button id="saveBtn">СКАЧАТЬ PRINT-READY</button>
        <div id="debugInfo" style="font-size:9px; color:#555; text-align:center;"></div>
    </div>

    <div id="cropperModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">Кадрирование</div>
            <div class="crop-controls">
                <button class="crop-btn" onclick="setCropMask(1,1)">1:1</button>
                <button class="crop-btn" onclick="setCropMask(5,9)">5:9</button>
                <button class="crop-btn" onclick="setCropMask(9,5)">9:5</button>
                <button class="crop-btn" onclick="setCropMask('circle')">Круг</button>
            </div>
            <div class="crop-area-wrapper"><canvas id="cropCanvas"></canvas></div>
            <div class="zoom-controls"><span>ZOOM</span><input type="range" id="zoomSlider" min="0.1" max="4" step="0.01" value="1"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="secondary" id="cancelCropBtn" style="flex:1;">Отмена</button>
                <button id="applyCropBtn" style="flex:1; background:var(--accent-gold); color:#fff;">Применить</button>
            </div>
        </div>
    </div>

    <div id="galleryModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header"><span id="galleryTitle">Галерея</span><span class="modal-close" onclick="closeGallery()">×</span></div>
            <div class="gallery-tabs" id="galleryTabs"></div>
            <div class="gallery-grid" id="galleryGrid"></div>
            <div style="border-top:1px solid #333; padding-top:15px; text-align:center;">
                <button id="galUploadBtn" class="secondary" onclick="handleGalleryUpload()">Загрузить свое</button>
            </div>
        </div>
    </div>

    <div id="qrModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">QR Код</div>
            <div style="color:#ccc; font-size:12px; text-align:center;">
                Введите ссылку (сайт, instagram).<br>QR-код будет цветом текста.
            </div>
            <input type="text" id="qrLinkInput" placeholder="https://..." value="https://">
            <div style="display:flex; gap:10px;">
                <button class="secondary" onclick="document.getElementById('qrModal').classList.add('hidden')" style="flex:1;">Отмена</button>
                <button onclick="applyQR()" style="flex:1; background:var(--accent-gold); color:#fff;">Добавить</button>
            </div>
            <div style="text-align:center;">
                <button class="secondary" onclick="removeQR()" style="border-color:#555; color:#777; font-size:10px; padding:8px;">Удалить QR</button>
            </div>
        </div>
    </div>

    <script>
        const EXPORT_DPI = 300, CM_TO_INCH = 2.54, SPINE_WIDTH_CM = 1.5, COPYRIGHT_TEXT = "DESIGN BY MALEVICH", RENDER_SCALE = 3.0;
        const GLOBAL_OPACITY = 0.80; 
        const TYPO_CONFIG = { baseTitle: 1.2, baseDetails: 0.5, baseCopy: 0.35 };
        const SCALES = [0.8, 1.0, 1.2, 1.5];

        let state = {
            bookSize: 30, layout: 'text_icon', ppi: 10,
            slotSize: { w: 6, h: 6 },
            maskType: 'rect',
            text: { 
                lines: [ { text: "", upper: false }, { text: "", upper: false }, { text: "", upper: false } ],
                date: "", spine: "", copyright: "", 
                font: "Tenor Sans", color: "#1a1a1a", scale: 1.0 
            },
            coverColor: "#FFFFFF",
            images: { icon: null, main: null }, 
            
            // SPINE STATE
            spine: { symbol: true, title: false, date: false },
            
            qr: { enabled: false, url: "" },
            visualW: 0, visualH: 0
        };

        const canvas = new fabric.Canvas('c', { backgroundColor: '#fff', selection: false, enableRetinaScaling: false });
        let cropCanvas = null, tempImgObject = null, activeCropSlot = { w: 0, h: 0 };
        const CROP_CANVAS_SIZE = 500;

        function loadSimpleImage(path, callback) {
            const img = new Image();
            img.onload = () => callback(path);
            img.onerror = () => callback(null);
            img.src = path;
        }

        // --- INIT & LOGIC ---
        function initColors() {
            try { if(typeof DESIGNER_PALETTES !== 'undefined') changeCollection('Wedding Trends'); } catch(e) {}
            document.getElementById('customCoverPicker').oninput = (e) => { state.coverColor = e.target.value; renderLayout(); };
            document.getElementById('customTextPicker').oninput = (e) => { state.text.color = e.target.value; updateSymbolUI(); renderLayout(); };
        }

        function changeCollection(name) {
            const grid = document.getElementById('pairsGrid');
            const customBlock = document.getElementById('customPickers');
            grid.innerHTML = '';
            if(name === 'Custom') { grid.classList.add('hidden'); customBlock.classList.remove('hidden'); return; }
            grid.classList.remove('hidden'); customBlock.classList.add('hidden');
            if(typeof DESIGNER_PALETTES !== 'undefined' && DESIGNER_PALETTES[name]) {
                DESIGNER_PALETTES[name].forEach(pair => {
                    const btn = document.createElement('div');
                    btn.className = 'pair-btn'; btn.style.backgroundColor = pair.bg;
                    if(pair.bg.toUpperCase() === '#FFFFFF') btn.style.border = '1px solid #ccc';
                    const heart = document.createElement('div');
                    heart.className = 'pair-heart'; heart.innerText = '❤'; heart.style.color = pair.text;
                    btn.appendChild(heart); btn.onclick = () => applyPair(pair, btn);
                    grid.appendChild(btn);
                });
                if(DESIGNER_PALETTES[name].length > 0) applyPair(DESIGNER_PALETTES[name][0], grid.firstChild);
            }
        }

        function applyPair(pair, btnElement) {
            state.coverColor = pair.bg; state.text.color = pair.text;
            document.querySelectorAll('.pair-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            updateSymbolUI();
            if(state.qr.enabled) { document.getElementById('qrBtn').style.color = pair.text; document.getElementById('qrBtn').style.borderColor = pair.text; }
            renderLayout();
        }

        window.updateScaleFromSlider = (val) => { const idx = parseInt(val) - 1; state.text.scale = SCALES[idx]; renderLayout(); }
        window.setScale = (scale, btn) => { const idx = SCALES.indexOf(scale); if(idx !== -1) { document.getElementById('textScale').value = idx + 1; state.text.scale = scale; renderLayout(); } }

        function loadDefaultAssets() {
            initColors();
            setTimeout(() => { document.getElementById('app-loader').style.opacity = '0'; setTimeout(() => document.getElementById('app-loader').style.display='none', 800); }, 1500);
            const relPath = 'icons/love/01heart.png';
            loadSimpleImage('assets/print/' + relPath, (url1) => {
                const final = url1 || ('assets/preview/' + relPath);
                loadSimpleImage(final, (validUrl) => { if(validUrl) state.images.icon = validUrl; finishInit(); });
            });
        }

        function finishInit() { updateSymbolUI(); setLayout('text_icon', document.querySelector('.layout-card.active')); updateCanvasDimensions(); }

        window.toggleCase = (rowIdx) => { const i = rowIdx - 1; state.text.lines[i].upper = !state.text.lines[i].upper; document.getElementById(`btnTt${rowIdx}`).classList.toggle('active', state.text.lines[i].upper); renderLayout(); };
        window.showRow = (rowIdx) => { document.getElementById(`row${rowIdx}`).classList.remove('hidden'); };
        window.hideRow = (rowIdx) => { document.getElementById(`row${rowIdx}`).classList.add('hidden'); document.getElementById(`inputLine${rowIdx}`).value = ""; state.text.lines[rowIdx-1].text = ""; renderLayout(); };

        function updateSymbolUI() {
            const globalBtn = document.getElementById('globalSymbolBtn');
            // Spine toggles get color update in logic, but visuals are static CSS mostly
            if(state.images.icon) {
                globalBtn.style.backgroundImage = `url(${state.images.icon})`;
                globalBtn.classList.add('active'); globalBtn.style.borderColor = state.text.color;
            } else {
                globalBtn.style.backgroundImage = 'none'; globalBtn.classList.remove('active'); globalBtn.style.borderColor = '#444';
            }
        }
        window.removeGlobalSymbol = () => { state.images.icon = null; updateSymbolUI(); renderLayout(); };
        
        // --- SPINE LOGIC (NEW) ---
        window.toggleSpinePart = (part) => {
            state.spine[part] = !state.spine[part];
            // Update button visual
            const btn = document.getElementById(part === 'symbol' ? 'btnSpineSymbol' : part === 'title' ? 'btnSpineTitle' : 'btnSpineDate');
            btn.classList.toggle('active', state.spine[part]);
            renderLayout();
        };

        // --- HANDLERS ---
        window.openQRModal = () => { document.getElementById('qrModal').classList.remove('hidden'); }
        window.applyQR = () => {
            const url = document.getElementById('qrLinkInput').value;
            if(url.length > 3) {
                state.qr.enabled = true; state.qr.url = url;
                document.getElementById('qrBtn').classList.add('active');
                document.getElementById('qrBtn').style.borderColor = state.text.color;
                document.getElementById('qrBtn').style.color = state.text.color;
                renderLayout();
            }
            document.getElementById('qrModal').classList.add('hidden');
        }
        window.removeQR = () => {
            state.qr.enabled = false;
            document.getElementById('qrBtn').classList.remove('active');
            document.getElementById('qrBtn').style.borderColor = '#444';
            document.getElementById('qrBtn').style.color = '#555';
            renderLayout(); document.getElementById('qrModal').classList.add('hidden');
        }
        window.setBookSize = (size, btn) => { state.bookSize = size; document.querySelectorAll('.format-card').forEach(b => b.classList.remove('active')); btn.classList.add('active'); updateCanvasDimensions(); }
        
        window.setLayout = (layoutType, btn) => {
            state.layout = layoutType;
            document.querySelectorAll('.layout-card').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            state.images.main = null; 
            if(state.layout === 'magazine' && layoutType !== 'magazine') { state.text.font = document.getElementById('fontSelector').value; }
            if(layoutType === 'magazine') { state.text.font = 'Bodoni Moda'; }
            if(layoutType === 'graphic') state.maskType = 'circle';
            else state.maskType = 'rect';
            renderLayout();
        }

        window.triggerAssetLoader = () => {
            if(state.layout === 'graphic') openGallery('graphics', 'main');
            else document.getElementById('imageLoader').click();
        }

        let curGalTarget = 'main'; 
        window.openGallery = (type, target) => { 
            curGalTarget = target; 
            document.getElementById('globalSymbolBtn').classList.remove('pulse-attention'); 
            document.getElementById('galleryModal').classList.remove('hidden'); 
            const upBtn = document.getElementById('galUploadBtn');
            if(type === 'icons') { upBtn.innerText = "Загрузить свою иконку"; upBtn.onclick = () => document.getElementById('iconLoader').click(); } 
            else { upBtn.innerText = "Загрузить свое фото"; upBtn.onclick = () => document.getElementById('imageLoader').click(); }
            const tabs = document.getElementById('galleryTabs'); tabs.innerHTML = ''; 
            let db = (type === 'icons') ? ASSETS_DB.icons : ASSETS_DB.graphics;
            if(!db) db = ASSETS_DB.icons;
            Object.keys(db).forEach((cat, i) => { const t = document.createElement('div'); t.className = `gallery-tab ${i===0?'active':''}`; t.innerText = cat; t.onclick = () => { document.querySelectorAll('.gallery-tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); loadGal(type, cat); }; tabs.appendChild(t); }); 
            if(Object.keys(db).length) loadGal(type, Object.keys(db)[0]); 
        }

        function loadGal(type, cat) { 
            const grid = document.getElementById('galleryGrid'); 
            let files = (type === 'icons' ? ASSETS_DB.icons[cat] : ASSETS_DB.graphics[cat]) || [];
            grid.innerHTML = ''; 
            for(let f of files) { 
                const item = document.createElement('div'); item.className = 'gallery-item'; 
                const img = document.createElement('img'); 
                const relPath = `${type}/${cat.toLowerCase()}/${f}`; 
                const previewUrl = 'assets/preview/' + relPath; 
                const printUrl = 'assets/print/' + relPath; 
                img.src = previewUrl; img.onerror = () => { img.src = printUrl; }; 
                item.appendChild(img); 
                item.onclick = () => { 
                    loadSimpleImage(printUrl, (url1) => { 
                        let finalUrl = url1 || previewUrl; 
                        document.getElementById('galleryModal').classList.add('hidden'); 
                        if(curGalTarget === 'global') { state.images.icon = finalUrl; updateSymbolUI(); renderLayout(); } 
                        else { if(type === 'graphics') { state.images.main = { src: finalUrl, cropInfo: { scale: 1, left: 0, top: 0, slotPixelSize: 100 } }; renderLayout(); } } 
                    }); 
                }; 
                grid.appendChild(item); 
            } 
        }
        
        window.closeGallery = () => document.getElementById('galleryModal').classList.add('hidden');
        window.handleGalleryUpload = () => { };

        document.getElementById('iconLoader').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => { state.images.icon = ev.target.result; updateSymbolUI(); renderLayout(); document.getElementById('galleryModal').classList.add('hidden'); }; if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); };
        document.getElementById('imageLoader').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => { document.getElementById('galleryModal').classList.add('hidden'); openCropper(ev.target.result); }; if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); e.target.value = ''; };

        function initCrop() { if(!cropCanvas) { cropCanvas = new fabric.Canvas('cropCanvas', { width: CROP_CANVAS_SIZE, height: CROP_CANVAS_SIZE, backgroundColor: '#111', selection: false }); } cropCanvas.clear(); cropCanvas.setBackgroundColor('#111'); }
        window.setCropMask = (w, h) => { if(w === 'circle') { state.slotSize = { w: 6, h: 6 }; state.maskType = 'circle'; } else { state.slotSize = { w: w, h: h }; state.maskType = 'rect'; } if(tempImgObject) drawCropOverlay(); };
        function drawCropOverlay() {
            cropCanvas.getObjects().forEach(o => { if(o !== tempImgObject) cropCanvas.remove(o); });
            const aspect = state.slotSize.w / state.slotSize.h;
            let slotPW, slotPH; 
            if(aspect >= 1) { slotPW = CROP_CANVAS_SIZE*0.8; slotPH = slotPW/aspect; } else { slotPH = CROP_CANVAS_SIZE*0.8; slotPW = slotPH*aspect; }
            activeCropSlot = { w: slotPW, h: slotPH };
            const cx = CROP_CANVAS_SIZE/2, cy = CROP_CANVAS_SIZE/2;
            const overlayColor = 'rgba(0,0,0,0.7)';
            if(state.maskType === 'circle') {
                const r = slotPW/2;
                const path = new fabric.Path(`M 0 0 H ${CROP_CANVAS_SIZE} V ${CROP_CANVAS_SIZE} H 0 Z M ${cx} ${cy-r} A ${r} ${r} 0 1 0 ${cx} ${cy+r} A ${r} ${r} 0 1 0 ${cx} ${cy-r} Z`, { fill: overlayColor, selectable: false, evented: false, fillRule: 'evenodd' });
                cropCanvas.add(path); cropCanvas.add(new fabric.Circle({ radius: r, left: cx, top: cy, originX:'center', originY:'center', fill: 'transparent', stroke: '#fff', strokeWidth: 1, selectable: false, evented: false }));
            } else {
                const path = new fabric.Path(`M 0 0 H ${CROP_CANVAS_SIZE} V ${CROP_CANVAS_SIZE} H 0 Z M ${cx-slotPW/2} ${cy-slotPH/2} H ${cx+slotPW/2} V ${cy+slotPH/2} H ${cx-slotPW/2} Z`, { fill: overlayColor, selectable: false, evented: false });
                cropCanvas.add(path); cropCanvas.add(new fabric.Rect({ left: cx, top: cy, width: slotPW, height: slotPH, fill: 'transparent', stroke: '#fff', strokeWidth: 1, originX: 'center', originY: 'center', selectable: false, evented: false }));
            }
            cropCanvas.requestRenderAll();
        }

        function openCropper(url) { 
            document.getElementById('cropperModal').classList.remove('hidden'); initCrop();
            fabric.Image.fromURL(url, (img) => { 
                tempImgObject = img; 
                let slotPW, slotPH; const aspect = state.slotSize.w / state.slotSize.h;
                if(aspect >= 1) { slotPW = CROP_CANVAS_SIZE*0.8; slotPH = slotPW/aspect; } else { slotPH = CROP_CANVAS_SIZE*0.8; slotPW = slotPH*aspect; }
                const scale = Math.max(slotPW/img.width, slotPH/img.height); 
                img.set({ left: CROP_CANVAS_SIZE/2, top: CROP_CANVAS_SIZE/2, originX: 'center', originY: 'center', scaleX: scale, scaleY: scale, hasControls: false, hasBorders: false }); 
                cropCanvas.add(img); drawCropOverlay();
                const slider = document.getElementById('zoomSlider'); slider.min = scale*0.5; slider.max = scale*4; slider.value = scale; 
                slider.oninput = function() { img.scale(parseFloat(this.value)); cropCanvas.requestRenderAll(); }; 
            }); 
        }
        
        document.getElementById('applyCropBtn').onclick = () => { 
            if(!tempImgObject) return; 
            const offX = tempImgObject.left - CROP_CANVAS_SIZE/2; const offY = tempImgObject.top - CROP_CANVAS_SIZE/2; 
            state.images.main = { src: tempImgObject.getSrc(), cropInfo: { left: offX, top: offY, scale: tempImgObject.scaleX, slotPixelSize: activeCropSlot.w } }; 
            renderLayout(); document.getElementById('cropperModal').classList.add('hidden'); 
        };
        document.getElementById('cancelCropBtn').onclick = () => document.getElementById('cropperModal').classList.add('hidden');

        // Render Canvas
        function updateCanvasDimensions() {
            const container = document.getElementById('workspace');
            const margin = 20; 
            const maxBookW = 30*2 + SPINE_WIDTH_CM; const maxBookH = 30;
            const basePPI = Math.max(5, Math.min((container.clientWidth - margin*2) / maxBookW, (container.clientHeight - margin*2) / maxBookH));
            state.ppi = basePPI * RENDER_SCALE;
            const curW = state.bookSize*2 + SPINE_WIDTH_CM; const curH = state.bookSize;
            canvas.setWidth(curW * state.ppi); canvas.setHeight(curH * state.ppi);
            canvas.wrapperEl.style.width = `${curW * basePPI}px`; canvas.wrapperEl.style.height = `${curH * basePPI}px`;
            canvas.lowerCanvasEl.style.width = '100%'; canvas.upperCanvasEl.style.width = '100%';
            canvas.lowerCanvasEl.style.height = '100%'; canvas.upperCanvasEl.style.height = '100%';
            renderLayout();
        }

        function renderLayout() {
            canvas.clear(); canvas.setBackgroundColor(state.coverColor);
            const h = canvas.height;
            const x1 = state.bookSize*state.ppi; const x2 = (state.bookSize+1.5)*state.ppi;
            const spineX = x1 + ((x2-x1)/2); const frontCenter = x2 + (state.bookSize*state.ppi/2);
            const backCenter = (state.bookSize*state.ppi)/2;

            const lineOpts = { stroke: state.text.color, strokeWidth: 2, strokeDashArray: [10,10], selectable: false, evented: false, opacity: 0.3 };
            canvas.add(new fabric.Line([x1,0,x1,h], lineOpts)); canvas.add(new fabric.Line([x2,0,x2,h], lineOpts));

            const bottomBase = h - (1.5 * state.ppi);

            // --- SPINE RENDER ---
            // 1. Symbol
            let symbolHeight = 0;
            if(state.images.icon && state.spine.symbol) {
                const size = 1.0 * state.ppi; 
                symbolHeight = size;
                fabric.Image.fromURL(state.images.icon, (img) => {
                    img.scaleToWidth(size); img.set({ originX: 'center', originY: 'bottom', left: spineX, top: bottomBase, selectable: false, opacity: GLOBAL_OPACITY });
                    const filter = new fabric.Image.filters.BlendColor({ color: state.text.color, mode: 'tint', alpha: 1 }); img.filters.push(filter); img.applyFilters(); canvas.add(img);
                });
            }

            // 2. Text (Name + Date)
            let spineTextParts = [];
            
            // Get inputs
            const l1 = document.getElementById('inputLine1').value;
            const l2 = document.getElementById('inputLine2').value;
            const l3 = document.getElementById('inputLine3').value;
            const d1 = document.getElementById('dateLine').value;

            if(state.spine.title) {
                const raw = [l1, l2, l3];
                const processed = raw.map((txt, i) => state.text.lines[i].upper ? txt.toUpperCase() : txt).filter(Boolean);
                if(processed.length > 0) spineTextParts.push(processed.join(" "));
            }
            if(state.spine.date && d1) {
                spineTextParts.push(d1);
            }

            if(spineTextParts.length > 0) {
                const spineStr = spineTextParts.join("   "); // Space between title and date
                let textBottom = bottomBase; 
                if(state.spine.symbol && state.images.icon) textBottom -= (1.8 * state.ppi); 
                
                canvas.add(new fabric.Text(spineStr, { 
                    fontFamily: state.text.font, 
                    fontSize: TYPO_CONFIG.baseDetails * state.ppi * state.text.scale, 
                    fill: state.text.color, opacity: GLOBAL_OPACITY, 
                    originX: 'left', originY: 'center', left: spineX, top: textBottom, angle: -90, selectable: false 
                }));
            }

            // 2. BACK COVER
            const copyInput = document.getElementById('copyrightInput').value;
            if(copyInput) {
                const copyTxt = new fabric.Text(copyInput, { left: backCenter, top: bottomBase, fontSize: TYPO_CONFIG.baseCopy * state.ppi * state.text.scale, fontFamily: state.text.font, fill: state.text.color, opacity: GLOBAL_OPACITY * 0.7, originX: 'center', originY: 'bottom', selectable: false, letterSpacing: 50 });
                canvas.add(copyTxt);
            }
            if(state.qr.enabled && state.qr.url) {
                const qrSize = 1.2 * state.ppi; const qrObj = new QRious({ value: state.qr.url, size: 500, level: 'H', foreground: state.text.color, backgroundAlpha: 0 });
                fabric.Image.fromURL(qrObj.toDataURL(), (img) => { img.scaleToWidth(qrSize); img.set({ left: backCenter, top: bottomBase - (0.5 * state.ppi) - (0.35 * state.ppi) - (0.5*state.ppi), originX: 'center', originY: 'bottom', selectable: false, opacity: GLOBAL_OPACITY }); canvas.add(img); });
            }

            // 3. FRONT COVER
            const cy = h/2; const gap = 2.0 * state.ppi;
            let triggerX = frontCenter; let triggerY = cy;

            if(state.layout === 'magazine') {
                if(state.images.main && state.images.main.src) {
                     fabric.Image.fromURL(state.images.main.src, (img) => {
                        const coverW = state.bookSize * state.ppi; const scale = Math.max(coverW / img.width, h / img.height);
                        img.set({ scaleX: scale, scaleY: scale, left: frontCenter, top: h/2, originX: 'center', originY: 'center', selectable: false });
                        img.clipPath = new fabric.Rect({ width: coverW/scale, height: h/scale, left: -coverW/2/scale, top: -h/2/scale });
                        canvas.add(img); canvas.sendToBack(img);
                    });
                }
                renderTextBlock(frontCenter, 2.0 * state.ppi, false, true); 
            }
            else if(state.layout === 'icon') { renderIcon(frontCenter, cy); } 
            else if(state.layout === 'text_icon') { 
                const dynamicGap = gap * state.text.scale;
                const tObj = createTextBlockObj(true);
                const iconSize = (2.0 / 1.6) * state.ppi * state.text.scale;
                const visualGap = dynamicGap * 1.5; 
                const totalH = tObj.height + visualGap + iconSize;
                const startY = cy - (totalH / 2);
                tObj.set({ left: frontCenter, top: startY + tObj.height/2 }); canvas.add(tObj);
                renderIcon(frontCenter, startY + tObj.height + visualGap + iconSize/2, iconSize);
            } 
            else if(state.layout === 'graphic' || state.layout === 'photo_text') {
                let imgY = cy; if(state.layout === 'photo_text') imgY = cy - gap/2;
                triggerY = imgY; 
                renderImageSlot(frontCenter, imgY);
                if(state.layout === 'photo_text') renderTextBlock(frontCenter, cy + gap*1.5, true); 
            }
            else if(state.layout === 'text') { const tObj = createTextBlockObj(); tObj.set({ left: frontCenter, top: cy }); canvas.add(tObj); } 
            
            // Trigger Pos
            const trigger = document.getElementById('photoTrigger');
            if( (state.layout === 'graphic' || state.layout === 'photo_text' || state.layout === 'magazine') && !state.images.main ) {
                trigger.classList.remove('hidden');
                const cssX = triggerX / RENDER_SCALE; const cssY = triggerY / RENDER_SCALE;
                trigger.style.left = `calc(${cssX}px - 25px)`; trigger.style.top = `calc(${cssY}px - 25px)`;
            } else { trigger.classList.add('hidden'); }

            document.getElementById('debugInfo').innerText = `Print: ${state.bookSize}cm @ 300DPI`;
        }

        function createTextBlockObj(compact = false) {
            const l1 = document.getElementById('inputLine1').value;
            const l2 = document.getElementById('inputLine2').value;
            const l3 = document.getElementById('inputLine3').value;
            const dateIn = document.getElementById('dateLine').value;
            const rawLines = [l1, l2, l3];
            const processedLines = rawLines.map((txt, i) => { return state.text.lines[i].upper ? txt.toUpperCase() : txt; });
            const hasText = l1 || l2 || l3;
            let renderTxt = hasText ? processedLines.filter(Boolean).join("\n") : "THE VISUAL DIARY\n\n\n";
            let finalOpacity = hasText ? GLOBAL_OPACITY : 0.3;
            const baseSize = compact ? 0.8 : TYPO_CONFIG.baseTitle; 
            const finalSize = baseSize * state.ppi * state.text.scale;
            const tObj = new fabric.Text(renderTxt, { fontFamily: state.text.font, fontSize: finalSize, textAlign: 'center', lineHeight: 1.3, fill: state.text.color, opacity: finalOpacity, selectable: false, originX: 'center', originY: 'center' });
            const group = new fabric.Group([tObj], { originX: 'center', originY: 'center' });
            if(dateIn || !hasText) { 
                const dateStr = dateIn ? dateIn : "2025";
                const dateOp = dateIn ? GLOBAL_OPACITY : 0.3;
                const dateSize = TYPO_CONFIG.baseDetails * state.ppi * state.text.scale;
                const dObj = new fabric.Text(dateStr, { fontFamily: state.text.font, fontSize: dateSize, fill: state.text.color, opacity: dateOp, originX: 'center', originY: 'top', top: tObj.height/2 + (compact ? 1.0 : 2.0)*state.ppi });
                group.addWithUpdate(dObj);
            }
            return group;
        }
        function renderTextBlock(x, y, compact, isMagazine = false) {
            if(isMagazine) {
                let txt = [document.getElementById('inputLine1').value, document.getElementById('inputLine2').value].filter(Boolean).join("\n");
                if(!txt) txt = "MAGAZINE";
                const tObj = new fabric.Text(txt, { fontFamily: 'Bodoni Moda', fontSize: 2.5 * state.ppi * state.text.scale, textAlign: 'center', lineHeight: 1.0, originX: 'center', originY: 'top', left: x, top: y, fill: state.text.color, selectable: false });
                canvas.add(tObj);
                return;
            }
            const group = createTextBlockObj(compact);
            group.set({ left: x, top: y });
            canvas.add(group);
        }
        function renderIcon(x, y, forcedSize = null) {
            let iconUrl = state.images.icon;
            let isGhost = false;
            if(!iconUrl) { iconUrl = 'assets/preview/icons/love/01heart.png'; isGhost = true; }
            let size = forcedSize ? forcedSize : (2.0 / 1.6) * state.ppi * state.text.scale;
            fabric.Image.fromURL(iconUrl, (img) => {
                if(!img) return;
                img.scaleToWidth(size);
                img.set({ left: x, top: y, originX: 'center', originY: 'center', selectable: false, opacity: isGhost ? 0.3 : GLOBAL_OPACITY });
                const filter = new fabric.Image.filters.BlendColor({ color: state.text.color, mode: 'tint', alpha: 1 });
                img.filters.push(filter); img.applyFilters();
                canvas.add(img);
            });
        }
        function renderImageSlot(x, y) {
            const w = state.slotSize.w * state.ppi; const h = state.slotSize.h * state.ppi;
            if(state.images.main && state.images.main.src) {
                fabric.Image.fromURL(state.images.main.src, (img) => {
                    const info = state.images.main.cropInfo; const scaleFactor = w / info.slotPixelSize;
                    img.set({ scaleX: info.scale * scaleFactor, scaleY: info.scale * scaleFactor, left: x + (info.left * scaleFactor), top: y + (info.top * scaleFactor), originX: 'center', originY: 'center', selectable: false });
                    let clip;
                    if(state.maskType === 'circle') {
                        clip = new fabric.Circle({ radius: (w * (1/(info.scale * scaleFactor))) / 2, left: -(info.left * scaleFactor) / (info.scale * scaleFactor), top: -(info.top * scaleFactor) / (info.scale * scaleFactor), originX: 'center', originY: 'center' });
                    } else {
                        clip = new fabric.Rect({ width: w * (1/(info.scale * scaleFactor)), height: h * (1/(info.scale * scaleFactor)), left: -(info.left * scaleFactor) / (info.scale * scaleFactor), top: -(info.top * scaleFactor) / (info.scale * scaleFactor), originX: 'center', originY: 'center' });
                    }
                    img.clipPath = clip;
                    if (state.layout === 'graphic') { img.set({ opacity: GLOBAL_OPACITY }); const filter = new fabric.Image.filters.BlendColor({ color: state.text.color, mode: 'tint', alpha: 1 }); img.filters.push(filter); img.applyFilters(); }
                    canvas.add(img);
                });
            } else {
                let rect;
                if(state.maskType === 'circle') {
                    rect = new fabric.Circle({ radius: w/2, fill: 'transparent', stroke: '#ddd', strokeWidth:2, strokeDashArray: [20,20], left: x, top: y, originX: 'center', originY: 'center', selectable: false });
                } else {
                    rect = new fabric.Rect({ width: w, height: h, fill: 'transparent', stroke: '#ddd', strokeWidth:2, strokeDashArray: [20,20], left: x, top: y, originX: 'center', originY: 'center', selectable: false });
                }
                canvas.add(rect); 
            }
        }

        document.getElementById('saveBtn').onclick = () => { try { const mult = (EXPORT_DPI / CM_TO_INCH) / state.ppi; canvas.getObjects('line').forEach(o => o.opacity = 0); const data = canvas.toDataURL({ format: 'png', multiplier: mult, quality: 1 }); canvas.getObjects('line').forEach(o => o.opacity = 0.3); const a = document.createElement('a'); a.download = `cover_${state.bookSize}cm.png`; a.href = data; document.body.appendChild(a); a.click(); document.body.removeChild(a); } catch(e) { alert("Ошибка сохранения: Браузер блокирует доступ (CORS)."); } };
        window.onload = loadDefaultAssets;
        window.addEventListener('resize', () => setTimeout(updateCanvasDimensions, 100));
    </script>
</body>
</html>
