<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MALEVICH | Configurator V39 (Text Builder)</title>
    
    <script src="assets.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400..900;1,6..96,400..900&family=Tenor+Sans&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* --- STYLES --- */
        @font-face { font-family: 'Tenor Sans'; src: url('fonts/TenorSans.ttf') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
        @font-face { font-family: 'Bodoni Moda'; src: url('fonts/BodoniModa.ttf') format('truetype'); font-weight: 400 900; font-style: normal; font-display: swap; }

        :root { --bg-canvas: #e0e0e0; --bg-panel: #1a1a1a; --text-panel: #e5e5e5; --accent-gold: #D4AF37; --border-color: #333; --input-bg: #252525; --card-bg: #222; --card-hover: #2a2a2a; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Tenor Sans', sans-serif; background-color: var(--bg-canvas); height: 100vh; display: flex; color: #333; overflow: hidden; }

        /* LAYOUT */
        #workspace { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; background-color: var(--bg-canvas); background-image: linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px); background-size: 50px 50px; overflow: auto; }
        .canvas-container { box-shadow: 0 40px 100px rgba(0,0,0,0.4); border: none; background: #fff; margin: auto; }
        canvas.lower-canvas, canvas.upper-canvas { width: 100% !important; height: 100% !important; }
        #controls { width: 400px; background: var(--bg-panel); color: var(--text-panel); padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 30px; box-shadow: -10px 0 30px rgba(0,0,0,0.2); z-index: 100; flex-shrink: 0; }

        /* TYPOGRAPHY */
        h1 { font-family: 'Bodoni Moda', serif; font-size: 24px; color: #fff; letter-spacing: 3px; margin-bottom: 10px; text-align: center; font-weight: 400; }
        h2 { font-family: 'Bodoni Moda', serif; font-size: 13px; color: var(--accent-gold); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 12px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-top: 5px; }
        label { display: block; margin-bottom: 8px; font-size: 10px; font-weight: bold; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        /* FORMATS */
        .format-selector { 
            display: flex; gap: 15px; justify-content: flex-start; align-items: flex-end; 
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #333; 
            overflow-x: auto; overflow-y: hidden; padding-top: 10px; /* Fix clipping */
        }
        .format-card { 
            border: 1px solid #444; background: var(--card-bg); cursor: pointer; 
            display: flex; justify-content: center; align-items: center; 
            transition: all 0.2s; position: relative; flex-shrink: 0; 
        }
        .format-card:hover { border-color: #777; background: var(--card-hover); }
        .format-card.active { border-color: var(--accent-gold); box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); background: #333; transform: translateY(-2px); }
        .format-card span { font-size: 10px; color: #aaa; pointer-events: none; position: absolute; }
        .f-30 { width: 80px; height: 80px; } .f-25 { width: 65px; height: 65px; } .f-20 { width: 50px; height: 50px; }

        /* LAYOUTS */
        .layout-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        .layout-card { aspect-ratio: 1; background: var(--card-bg); border: 1px solid #444; cursor: pointer; border-radius: 4px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; transition: all 0.2s; }
        .layout-card:hover { border-color: #777; background: var(--card-hover); }
        .layout-card.active { border-color: var(--accent-gold); box-shadow: 0 0 8px rgba(212, 175, 55, 0.2); }
        .layout-name { font-size: 9px; color: #777; margin-top: 5px; text-align: center; }
        .mini-line { width: 60%; height: 2px; background: #666; border-radius: 2px; } .mini-line.short { width: 40%; }
        .mini-icon { width: 12px; height: 12px; border: 1px solid #777; border-radius: 50%; display: grid; place-items: center; }
        .mini-icon::after { content: '❤'; font-size: 8px; color: #777; line-height: 1; }
        .mini-photo { width: 70%; height: 50%; background: #333; border: 1px dashed #555; }
        .mini-art { width: 60%; height: 60%; border: 1px solid #777; border-radius: 50%; }

        /* COLORS */
        .color-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; margin-bottom: 15px; }
        .color-btn { width: 100%; aspect-ratio: 1; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; position: relative; }
        .color-btn:hover { transform: scale(1.1); z-index: 2; }
        .color-btn.active { border-color: #fff; transform: scale(1.15); box-shadow: 0 0 10px rgba(255,255,255,0.3); z-index: 2; }
        .color-btn.custom-picker { border: 1px dashed #777; background: transparent; display: grid; place-items: center; }
        .color-btn.custom-picker::after { content: '+'; color: #777; font-size: 16px; }
        .color-tooltip { position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 4px 8px; font-size: 10px; border-radius: 4px; opacity: 0; pointer-events: none; transition: opacity 0.2s; white-space: nowrap; z-index: 10; }
        .color-btn:hover .color-tooltip { opacity: 1; }

        /* TEXT BUILDER (NEW) */
        .text-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: stretch; }
        .text-row input { margin-bottom: 0; flex-grow: 1; }
        .tool-btn { 
            width: 42px; min-width: 42px; border: 1px solid #444; background: var(--input-bg); color: #777;
            display: grid; place-items: center; cursor: pointer; transition: 0.2s; font-family: 'Tenor Sans'; font-size: 12px;
        }
        .tool-btn:hover { border-color: #777; color: #fff; background: #333; }
        .tool-btn.active { border-color: var(--accent-gold); color: var(--accent-gold); background: #222; }
        .tool-btn.red:hover { border-color: #962f2f; color: #962f2f; }

        /* SYMBOL UI */
        .symbol-control-wrapper {
            display: flex; gap: 15px; align-items: flex-start; margin-top: 10px;
            background: #222; padding: 10px; border-radius: 4px; border: 1px solid #333;
        }
        .current-symbol-preview {
            width: 60px; height: 60px; border: 1px dashed #555; background: #1a1a1a;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s; position: relative; flex-shrink: 0;
        }
        .current-symbol-preview img { max-width: 80%; max-height: 80%; object-fit: contain; }
        .current-symbol-preview .placeholder { font-size: 24px; color: #444; }
        .symbol-actions { display: flex; flex-direction: column; gap: 8px; justify-content: center; height: 60px; }
        .text-link { font-size: 10px; text-decoration: underline; cursor: pointer; color: #999; font-family: 'Tenor Sans', sans-serif; text-transform: uppercase; letter-spacing: 0.5px; }
        .text-link:hover { color: #fff; }
        .text-link.delete { color: #962f2f; text-decoration: none; }
        .text-link.delete:hover { color: #ff4d4d; }

        /* SLIDERS */
        input[type=range] { -webkit-appearance: none; width: 100%; height: 2px; background: #444; outline: none; margin-bottom: 15px; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; border-radius: 50%; background: var(--accent-gold); cursor: pointer; transition: transform 0.2s; border: 2px solid #222; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* INPUTS & ICONS */
        .input-row-icon { display: flex; gap: 10px; align-items: stretch; margin-bottom: 15px; }
        .icon-trigger-btn { 
            width: 46px; border: 1px solid #444; background: var(--input-bg); 
            display: grid; place-items: center; cursor: pointer; transition: 0.3s;
            color: #555; font-size: 18px; 
            background-size: 60%; background-position: center; background-repeat: no-repeat;
            flex-shrink: 0;
        }
        .icon-trigger-btn:hover { border-color: #777; color: #999; }
        .icon-trigger-btn.active { border-color: var(--accent-gold); } 
        
        select, input[type="text"] { font-family: 'Tenor Sans', sans-serif; width: 100%; padding: 12px; margin-bottom: 15px; background: var(--input-bg); border: 1px solid var(--border-color); color: #fff; border-radius: 2px; font-size: 14px; transition: border 0.3s; }
        select:focus, input:focus { border-color: var(--accent-gold); }
        button { background-color: #fff; color: #000; cursor: pointer; border: none; padding: 12px; font-weight: bold; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s; }
        button:hover { background-color: var(--accent-gold); color: #fff; }
        button.secondary { background: transparent; border: 1px solid #555; color: #ccc; }
        button.secondary:hover { border-color: #fff; color: #fff; background: transparent; }
        .btn-row { display: flex; gap: 10px; margin-bottom: 10px;} .btn-row button { flex: 1; }
        .slot-options { display: flex; gap: 5px; margin-bottom: 15px; }
        .slot-btn { flex: 1; padding: 10px; font-size: 11px; background: var(--input-bg); border: 1px solid var(--border-color); color: #888; }
        .slot-btn:hover { color: #fff; } .slot-btn.active { background: #fff; color: #000; border-color: #fff; }
        #saveBtn { margin-top: auto; background-color: var(--accent-gold); color: #fff; padding: 18px; font-size: 14px; }
        .hidden { display: none !important; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 30px; border-radius: 4px; border: 1px solid #333; width: 95%; max-width: 600px; display: flex; flex-direction: column; gap: 20px; max-height: 90vh; }
        .modal-header { font-family: 'Bodoni Moda', serif; color: #fff; text-align: center; font-size: 18px; position: relative; }
        .modal-close { position: absolute; right: 0; top: -5px; cursor: pointer; font-size: 20px; color: #777; } .modal-close:hover { color: #fff; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 15px; overflow-y: auto; padding: 10px; min-height: 200px; }
        .gallery-item { aspect-ratio: 1; border: 1px solid #333; background: #222; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s; padding: 10px; }
        .gallery-item img { max-width: 100%; max-height: 100%; object-fit: contain; filter: grayscale(1); pointer-events: none; }
        .gallery-item:hover { border-color: var(--accent-gold); background: #2a2a2a; } .gallery-item:hover img { filter: grayscale(0); transform: scale(1.1); }
        .gallery-tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .gallery-tab { padding: 8px 15px; font-size: 11px; color: #888; cursor: pointer; border: 1px solid transparent; white-space: nowrap; }
        .gallery-tab.active { color: #fff; border: 1px solid var(--accent-gold); background: rgba(212, 175, 55, 0.1); }
        .crop-area-wrapper { background: #000; padding: 10px; display: flex; justify-content: center; }
        .zoom-controls { color: #fff; font-size: 12px; display: flex; align-items: center; gap: 15px; } input[type=range] { accent-color: var(--accent-gold); flex: 1; cursor: pointer; }

        /* LOADER */
        #app-loader { position: fixed; top:0; left:0; width:100%; height:100%; background: #1a1a1a; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; transition: opacity 0.8s ease; }
        .loader-text { font-family: 'Bodoni Moda', serif; font-size: 32px; letter-spacing: 5px; margin-bottom: 20px; animation: pulse 2s infinite; }
        .loader-sub { font-size: 10px; color: #555; letter-spacing: 2px; font-family: 'Tenor Sans'; text-transform: uppercase; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="app-loader">
        <div class="loader-text">MALEVICH</div>
        <div class="loader-sub">EST. 2025</div>
    </div>

    <div id="workspace">
        <canvas id="c"></canvas>
    </div>

    <div id="controls">
        <h1>MALEVICH</h1>
        
        <div class="section">
            <h2>1. Название Книги</h2>
            
            <div id="textBuilder">
                <div class="text-row" id="row1">
                    <input type="text" id="inputLine1" placeholder="Заголовок">
                    <div class="tool-btn" onclick="toggleCase(1)" id="btnTt1">Tt</div>
                    <div class="tool-btn" onclick="showRow(2)">+</div>
                </div>

                <div class="text-row" id="row2">
                    <input type="text" id="inputLine2" placeholder="Подзаголовок">
                    <div class="tool-btn" onclick="toggleCase(2)" id="btnTt2">Tt</div>
                    <div class="tool-btn" onclick="showRow(3)">+</div>
                    <div class="tool-btn red" onclick="clearRow(2)">×</div>
                </div>

                <div class="text-row hidden" id="row3">
                    <input type="text" id="inputLine3" placeholder="Доп. строка">
                    <div class="tool-btn" onclick="toggleCase(3)" id="btnTt3">Tt</div>
                    <div class="tool-btn red" onclick="clearRow(3)">×</div>
                </div>

                <label style="margin-top:10px;">Дата / Подпись</label>
                <input type="text" id="dateLine" placeholder="2025" style="margin-bottom:0;">
            </div>

            <div id="imageSection" class="hidden" style="margin-top:20px;">
                <label id="imgSecTitle">Изображение</label>
                <div class="slot-options">
                    <button class="slot-btn active" onclick="setSlotSize(6,6)">1:1</button>
                    <button class="slot-btn" onclick="setSlotSize(5,9)">5:9</button>
                    <button class="slot-btn" onclick="setSlotSize(9,5)">9:5</button>
                </div>
                <div class="btn-row">
                    <button id="openGraphicGalleryBtn" onclick="openGallery('graphics', 'main')" class="hidden">Галерея</button>
                    <button id="uploadImageBtn">Загрузить</button>
                </div>
                <input type="file" id="imageLoader" hidden accept="image/*">
            </div>
        </div>

        <div class="section">
            <label>2. Формат Книги</label>
            <div class="format-selector">
                <div class="format-card f-30 active" onclick="setBookSize(30, this)"><span>30x30</span></div>
                <div class="format-card f-25" onclick="setBookSize(25, this)"><span>25x25</span></div>
                <div class="format-card f-20" onclick="setBookSize(20, this)"><span>20x20</span></div>
            </div>
        </div>

        <div class="section">
            <h2>3. Материалы</h2>
            <label>Цвет Обложки</label>
            <div id="coverColorGrid" class="color-grid"></div>
            <input type="color" id="customCoverPicker" style="visibility:hidden; position:absolute;">
            
            <label style="margin-top:15px;">Цвет Элементов</label>
            <div id="textColorGrid" class="color-grid"></div>
            <input type="color" id="customTextPicker" style="visibility:hidden; position:absolute;">
        </div>

        <div class="section">
            <h2>4. Типографика</h2>
            
            <label>Символ / Шрифт</label>
            <div class="input-row-icon">
                <div id="globalSymbolBtn" class="icon-trigger-btn" onclick="openGallery('icons', 'global')"></div>
                <select id="fontSelector" style="margin-bottom:0;">
                    <option value="Tenor Sans">Tenor Sans (Гротеск)</option>
                    <option value="Bodoni Moda">Bodoni Moda (Засечки)</option>
                </select>
            </div>

            <label>Размер Текста/Элементов</label>
            <input type="range" id="textScale" min="0.8" max="1.6" step="0.1" value="1.0">

            <label style="margin-top:10px;">Символ (Глобально)</label>
            <div class="symbol-control-wrapper">
                <div class="current-symbol-preview" id="globalSymbolPreview">
                    <span class="placeholder">+</span>
                </div>
                <div class="symbol-actions">
                    <span class="text-link" onclick="openGallery('icons', 'global')">Выбрать из галереи</span>
                    <span class="text-link" onclick="document.getElementById('iconLoader').click()">Загрузить свой</span>
                    <span class="text-link delete" onclick="removeGlobalSymbol()">Удалить</span>
                </div>
            </div>
            <input type="file" id="iconLoader" hidden accept="image/png">
        </div>

        <div class="section">
            <h2>5. Дизайн Обложки</h2>
            <div class="layout-grid">
                <div class="layout-card" onclick="setLayout('icon', this)"><div class="mini-icon"></div><div class="layout-name">Символ</div></div>
                <div class="layout-card active" onclick="setLayout('text_icon', this)"><div class="mini-line"></div><div class="mini-line short"></div><div class="mini-icon" style="margin-top:4px"></div><div class="layout-name">Текст+Символ</div></div>
                <div class="layout-card" onclick="setLayout('graphic', this)"><div class="mini-art"></div><div class="layout-name">Графика</div></div>
                <div class="layout-card" onclick="setLayout('text', this)"><div class="mini-line"></div><div class="mini-line"></div><div class="mini-line short"></div><div class="layout-name">Текст</div></div>
                <div class="layout-card" onclick="setLayout('photo_text', this)"><div class="mini-photo"></div><div class="mini-line short" style="margin-top:4px"></div><div class="layout-name">Фото+Текст</div></div>
            </div>
        </div>
        
        <div class="section">
            <h2>6. Детали</h2>
            <label>Корешок (Вкл/Выкл Символ)</label>
            <div class="input-row-icon">
                <div id="spineIconBtn" class="icon-trigger-btn" onclick="toggleSpineSymbol()"></div>
                <input type="text" id="spineInput" placeholder="Текст на корешке..." style="margin-bottom:0;">
            </div>
            <label>Копирайт / QR</label>
            <div class="input-row-icon">
                <div id="qrBtn" class="icon-trigger-btn" style="font-size:12px; font-family:'Tenor Sans';" onclick="openQRModal()">QR</div>
                <input type="text" id="copyrightInput" value="DESIGN BY MALEVICH" placeholder="Копирайт..." style="margin-bottom:0;">
            </div>
        </div>

        <button id="saveBtn">СКАЧАТЬ PRINT-READY</button>
        <div id="debugInfo" style="font-size:9px; color:#555; text-align:center;"></div>
    </div>

    <div id="cropperModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">Кадрирование</div>
            <div class="crop-area-wrapper"><canvas id="cropCanvas"></canvas></div>
            <div class="zoom-controls"><span>ZOOM</span><input type="range" id="zoomSlider" min="0.1" max="4" step="0.01" value="1"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="secondary" id="cancelCropBtn" style="flex:1;">Отмена</button>
                <button id="applyCropBtn" style="flex:1; background:var(--accent-gold); color:#fff;">Применить</button>
            </div>
        </div>
    </div>

    <div id="galleryModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header"><span id="galleryTitle">Галерея</span><span class="modal-close" onclick="closeGallery()">×</span></div>
            <div class="gallery-tabs" id="galleryTabs"></div>
            <div class="gallery-grid" id="galleryGrid"></div>
            <div style="border-top:1px solid #333; padding-top:15px; text-align:center;">
                <button class="secondary" onclick="document.getElementById('iconLoader').click(); closeGallery()">Загрузить свой файл</button>
            </div>
        </div>
    </div>

    <div id="qrModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">QR Код</div>
            <div style="color:#ccc; font-size:12px; text-align:center;">
                Введите ссылку (сайт, instagram).<br>QR-код будет цветом текста.
            </div>
            <input type="text" id="qrLinkInput" placeholder="https://..." value="https://">
            <div style="display:flex; gap:10px;">
                <button class="secondary" onclick="document.getElementById('qrModal').classList.add('hidden')" style="flex:1;">Отмена</button>
                <button onclick="applyQR()" style="flex:1; background:var(--accent-gold); color:#fff;">Добавить</button>
            </div>
            <div style="text-align:center;">
                <button class="secondary" onclick="removeQR()" style="border-color:#555; color:#777; font-size:10px; padding:8px;">Удалить QR</button>
            </div>
        </div>
    </div>

    <script>
        const EXPORT_DPI = 300, CM_TO_INCH = 2.54, SPINE_WIDTH_CM = 1.5, COPYRIGHT_TEXT = "DESIGN BY MALEVICH", RENDER_SCALE = 3.0;
        const GLOBAL_OPACITY = 0.80; 
        const TYPO_CONFIG = { baseTitle: 1.2, baseDetails: 0.5, baseCopy: 0.35 };

        let state = {
            bookSize: 30, layout: 'text_icon', ppi: 10,
            slotSize: { w: 6, h: 6 },
            text: { 
                // Track state for 3 lines
                lines: [
                    { text: "", upper: false }, 
                    { text: "", upper: false }, 
                    { text: "", upper: false }
                ],
                date: "", spine: "", copyright: "DESIGN BY MALEVICH", 
                font: "Tenor Sans", color: "#1a1a1a", scale: 1.0 
            },
            coverColor: "#FFFFFF",
            images: { icon: null, main: null }, 
            spineSymbolEnabled: true,
            qr: { enabled: false, url: "" },
            visualW: 0, visualH: 0
        };

        const canvas = new fabric.Canvas('c', { backgroundColor: '#fff', selection: false, enableRetinaScaling: false });
        let cropCanvas = null, tempImgObject = null, activeCropSlot = { w: 0, h: 0 };
        const CROP_CANVAS_SIZE = 500;

        function loadSimpleImage(path, callback) {
            const img = new Image();
            img.onload = () => callback(path);
            img.onerror = () => callback(null);
            img.src = path;
        }

        // --- INIT & COLORS ---
        function initColors() {
            const coverContainer = document.getElementById('coverColorGrid');
            COLORS_DB.covers.forEach((col, i) => {
                const btn = document.createElement('div');
                if(col.hex === 'custom') {
                    btn.className = 'color-btn custom-picker'; btn.onclick = () => document.getElementById('customCoverPicker').click();
                } else {
                    btn.className = `color-btn ${i===0 ? 'active' : ''}`; btn.style.backgroundColor = col.hex;
                    if(col.hex.toUpperCase() === '#FFFFFF') btn.style.border = '1px solid #ccc';
                    btn.onclick = () => applyCoverColor(col.hex, col.contrast, btn);
                }
                coverContainer.appendChild(btn);
            });
            document.getElementById('customCoverPicker').oninput = (e) => applyCoverColor(e.target.value, '#1a1a1a', document.querySelector('.color-btn.custom-picker'));

            const textContainer = document.getElementById('textColorGrid');
            COLORS_DB.elements.forEach(col => {
                const btn = document.createElement('div');
                if(col.hex === 'custom') {
                    btn.className = 'color-btn custom-picker'; btn.onclick = () => document.getElementById('customTextPicker').click();
                } else {
                    btn.className = `color-btn ${col.hex === '#1a1a1a' ? 'active' : ''}`; btn.style.backgroundColor = col.hex;
                    if(col.hex.toUpperCase() === '#FFFFFF') btn.style.border = '1px solid #ccc';
                    btn.setAttribute('data-color', col.hex); btn.onclick = () => setTextColor(col.hex, btn);
                }
                textContainer.appendChild(btn);
            });
            document.getElementById('customTextPicker').oninput = (e) => setTextColor(e.target.value, document.querySelector('#textColorGrid .color-btn.custom-picker'));
        }

        function applyCoverColor(hex, contrast, btn) {
            state.coverColor = hex; if(contrast) setTextColor(contrast, null); 
            document.querySelectorAll('#coverColorGrid .color-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active'); renderLayout();
        }

        function loadDefaultAssets() {
            initColors();
            setTimeout(() => { document.getElementById('app-loader').style.opacity = '0'; setTimeout(() => document.getElementById('app-loader').style.display='none', 800); }, 1500);
            
            const relPath = 'icons/love/01heart.png';
            loadSimpleImage('assets/print/' + relPath, (url1) => {
                const final = url1 || ('assets/preview/' + relPath);
                loadSimpleImage(final, (validUrl) => {
                    if(validUrl) state.images.icon = validUrl;
                    finishInit();
                });
            });
        }

        function finishInit() { 
            updateSymbolUI();
            // Default Layout: Text+Symbol (matches UI order)
            setLayout('text_icon', document.querySelector('.layout-card.active')); 
            updateCanvasDimensions(); 
        }

        // --- TEXT BUILDER LOGIC (NEW) ---
        window.toggleCase = (rowIdx) => {
            const i = rowIdx - 1;
            state.text.lines[i].upper = !state.text.lines[i].upper;
            // Update button UI
            document.getElementById(`btnTt${rowIdx}`).classList.toggle('active', state.text.lines[i].upper);
            renderLayout();
        };

        window.showRow = (rowIdx) => {
            document.getElementById(`row${rowIdx}`).classList.remove('hidden');
        };

        window.clearRow = (rowIdx) => {
            document.getElementById(`inputLine${rowIdx}`).value = "";
            state.text.lines[rowIdx-1].text = "";
            renderLayout();
        };

        // --- GLOBAL SYMBOL ---
        function updateSymbolUI() {
            const globalBtn = document.getElementById('globalSymbolBtn');
            const preview = document.getElementById('globalSymbolPreview');
            const spineBtn = document.getElementById('spineIconBtn');
            
            if(state.images.icon) {
                globalBtn.style.backgroundImage = `url(${state.images.icon})`;
                globalBtn.classList.add('active');
                globalBtn.style.borderColor = state.text.color;

                preview.innerHTML = `<img src="${state.images.icon}">`;
                
                spineBtn.style.backgroundImage = `url(${state.images.icon})`;
                spineBtn.classList.toggle('active', state.spineSymbolEnabled);
                spineBtn.style.opacity = state.spineSymbolEnabled ? 1 : 0.5;
                spineBtn.style.borderColor = state.spineSymbolEnabled ? state.text.color : '#444';
                spineBtn.style.cursor = 'pointer';
            } else {
                globalBtn.style.backgroundImage = 'none';
                globalBtn.classList.remove('active');
                globalBtn.style.borderColor = '#444';

                preview.innerHTML = '<span class="placeholder">+</span>';
                spineBtn.style.backgroundImage = 'none';
                spineBtn.classList.remove('active');
                spineBtn.style.cursor = 'default';
                spineBtn.style.borderColor = '#444';
            }
        }

        window.removeGlobalSymbol = () => { state.images.icon = null; updateSymbolUI(); renderLayout(); };
        window.toggleSpineSymbol = () => { if(!state.images.icon) return; state.spineSymbolEnabled = !state.spineSymbolEnabled; updateSymbolUI(); renderLayout(); };

        // --- SPINE & QR ---
        window.openQRModal = () => { document.getElementById('qrModal').classList.remove('hidden'); }
        window.applyQR = () => {
            const url = document.getElementById('qrLinkInput').value;
            if(url.length > 3) {
                state.qr.enabled = true; state.qr.url = url;
                document.getElementById('qrBtn').classList.add('active');
                document.getElementById('qrBtn').style.borderColor = state.text.color;
                document.getElementById('qrBtn').style.color = state.text.color;
                renderLayout();
            }
            document.getElementById('qrModal').classList.add('hidden');
        }
        window.removeQR = () => {
            state.qr.enabled = false;
            document.getElementById('qrBtn').classList.remove('active');
            document.getElementById('qrBtn').style.borderColor = '#444';
            document.getElementById('qrBtn').style.color = '#555';
            renderLayout(); document.getElementById('qrModal').classList.add('hidden');
        }

        // --- UI ---
        window.setBookSize = (size, btn) => {
            state.bookSize = size;
            document.querySelectorAll('.format-card').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); updateCanvasDimensions();
        }

        window.setLayout = (layoutType, btn) => {
            state.layout = layoutType;
            document.querySelectorAll('.layout-card').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            ['imageSection'].forEach(id => document.getElementById(id).classList.add('hidden'));
            const imgBtn = document.getElementById('uploadImageBtn');
            const graphicBtn = document.getElementById('openGraphicGalleryBtn');
            const imgTitle = document.getElementById('imgSecTitle');

            switch(layoutType) {
                case 'graphic': 
                    document.getElementById('imageSection').classList.remove('hidden'); imgTitle.innerText = "Графика";
                    imgBtn.classList.add('hidden'); graphicBtn.classList.remove('hidden'); break;
                case 'photo_text': 
                    document.getElementById('imageSection').classList.remove('hidden');
                    imgTitle.innerText = "Фотография"; imgBtn.classList.remove('hidden'); graphicBtn.classList.add('hidden'); break;
            }
            renderLayout();
        }

        window.setTextColor = (color, btn) => {
            state.text.color = color;
            document.querySelectorAll('#textColorGrid .color-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            else {
                const target = Array.from(document.querySelectorAll('#textColorGrid .color-btn')).find(b => b.getAttribute('data-color')?.toUpperCase() === color.toUpperCase());
                if(target) target.classList.add('active');
            }
            updateSymbolUI();
            if(state.qr.enabled) { document.getElementById('qrBtn').style.color = color; document.getElementById('qrBtn').style.borderColor = color; }
            renderLayout();
        };

        // --- RENDER ENGINE ---
        function updateCanvasDimensions() {
            const container = document.getElementById('workspace');
            const margin = 20; 
            const maxBookW = 30*2 + SPINE_WIDTH_CM; const maxBookH = 30;
            const basePPI = Math.max(5, Math.min((container.clientWidth - margin*2) / maxBookW, (container.clientHeight - margin*2) / maxBookH));
            state.ppi = basePPI * RENDER_SCALE;
            
            const curW = state.bookSize*2 + SPINE_WIDTH_CM; const curH = state.bookSize;
            canvas.setWidth(curW * state.ppi); canvas.setHeight(curH * state.ppi);
            canvas.wrapperEl.style.width = `${curW * basePPI}px`; canvas.wrapperEl.style.height = `${curH * basePPI}px`;
            canvas.lowerCanvasEl.style.width = '100%'; canvas.upperCanvasEl.style.width = '100%';
            canvas.lowerCanvasEl.style.height = '100%'; canvas.upperCanvasEl.style.height = '100%';
            renderLayout();
        }

        function renderLayout() {
            canvas.clear(); canvas.setBackgroundColor(state.coverColor);
            const h = canvas.height;
            const x1 = state.bookSize*state.ppi; const x2 = (state.bookSize+1.5)*state.ppi;
            const spineX = x1 + ((x2-x1)/2); const frontCenter = x2 + (state.bookSize*state.ppi/2);
            const backCenter = (state.bookSize*state.ppi)/2;

            const lineOpts = { stroke: state.text.color, strokeWidth: 2, strokeDashArray: [10,10], selectable: false, evented: false, opacity: 0.3 };
            canvas.add(new fabric.Line([x1,0,x1,h], lineOpts)); canvas.add(new fabric.Line([x2,0,x2,h], lineOpts));

            const bottomBase = h - (1.5 * state.ppi);

            // 1. SPINE SYMBOL
            if(state.images.icon && state.spineSymbolEnabled) {
                const size = 1.0 * state.ppi; // 1cm
                fabric.Image.fromURL(state.images.icon, (img) => {
                    img.scaleToWidth(size);
                    img.set({ originX: 'center', originY: 'bottom', left: spineX, top: bottomBase, selectable: false, opacity: GLOBAL_OPACITY });
                    const filter = new fabric.Image.filters.BlendColor({ color: state.text.color, mode: 'tint', alpha: 1 });
                    img.filters.push(filter); img.applyFilters();
                    canvas.add(img);
                });
            }

            // SPINE TEXT
            const spineInput = document.getElementById('spineInput').value;
            const hasSpineText = !!spineInput;
            const spineStr = hasSpineText ? spineInput : "THE WEDDING DAY";
            const spineOpacity = hasSpineText ? GLOBAL_OPACITY : 0.3;

            let textBottom = bottomBase;
            if(state.images.icon && state.spineSymbolEnabled) textBottom -= (1.2 * state.ppi); 
            
            const spineTxt = new fabric.Text(spineStr, {
                fontFamily: state.text.font, 
                fontSize: TYPO_CONFIG.baseDetails * state.ppi * state.text.scale,
                fill: state.text.color, opacity: spineOpacity,
                originX: 'left', originY: 'center', left: spineX, top: textBottom, angle: -90, selectable: false
            });
            canvas.add(spineTxt);

            // 2. BACK COVER
            const copyTxt = new fabric.Text(state.text.copyright, {
                left: backCenter, top: bottomBase,
                fontSize: TYPO_CONFIG.baseCopy * state.ppi * state.text.scale,
                fontFamily: state.text.font, fill: state.text.color, opacity: GLOBAL_OPACITY * 0.7, 
                originX: 'center', originY: 'bottom', selectable: false, letterSpacing: 50
            });
            canvas.add(copyTxt);

            if(state.qr.enabled && state.qr.url) {
                const qrSize = 1.2 * state.ppi;
                const qrObj = new QRious({ 
                    value: state.qr.url, size: 500, level: 'H', 
                    foreground: state.text.color, backgroundAlpha: 0 
                });
                fabric.Image.fromURL(qrObj.toDataURL(), (img) => {
                    img.scaleToWidth(qrSize);
                    img.set({
                        left: backCenter, 
                        top: bottomBase - (0.5 * state.ppi) - (0.35 * state.ppi) - (0.5*state.ppi),
                        originX: 'center', originY: 'bottom', selectable: false,
                        opacity: GLOBAL_OPACITY
                    });
                    canvas.add(img);
                });
            }

            // 3. FRONT COVER
            const cy = h/2;
            const gap = 2.0 * state.ppi;

            if(state.layout === 'icon') { renderIcon(frontCenter, cy); } 
            else if(state.layout === 'text_icon') { 
                const dynamicGap = gap * state.text.scale;
                renderTextBlock(frontCenter, cy - dynamicGap/1.5, true); 
                renderIcon(frontCenter, cy + dynamicGap); 
            } 
            else if(state.layout === 'graphic') { renderImageSlot(frontCenter, cy); } 
            else if(state.layout === 'text') { renderTextBlock(frontCenter, cy, false); } 
            else if(state.layout === 'photo_text') { renderImageSlot(frontCenter, cy - gap/2); renderTextBlock(frontCenter, cy + gap*1.5, true); }
            
            document.getElementById('debugInfo').innerText = `Print: ${state.bookSize}cm @ 300DPI`;
        }

        // --- SUB RENDERERS ---
        function createTextBlockObj(compact = false) {
            // Read Inputs
            const l1 = document.getElementById('inputLine1').value;
            const l2 = document.getElementById('inputLine2').value;
            const l3 = document.getElementById('inputLine3').value;
            const dateIn = document.getElementById('dateLine').value;

            // Transform based on State
            const rawLines = [l1, l2, l3];
            const processedLines = rawLines.map((txt, i) => {
                return state.text.lines[i].upper ? txt.toUpperCase() : txt;
            });

            const hasText = l1 || l2 || l3;
            const txtColor = state.text.color;
            
            let renderTxt = "";
            let finalOpacity = GLOBAL_OPACITY;

            if (hasText) {
                renderTxt = processedLines.filter(Boolean).join("\n");
            } else {
                renderTxt = "THE MOMENTS\nMemories\nAnna & Sergey";
                finalOpacity = 0.3; // Ghost
            }

            const baseSize = compact ? 0.8 : TYPO_CONFIG.baseTitle; 
            const finalSize = baseSize * state.ppi * state.text.scale;

            const tObj = new fabric.Text(renderTxt, { 
                fontFamily: state.text.font, fontSize: finalSize, 
                textAlign: 'center', lineHeight: 1.3, fill: txtColor, opacity: finalOpacity, selectable: false,
                originX: 'center', originY: 'center'
            });
            
            const group = new fabric.Group([tObj], { originX: 'center', originY: 'center' });
            
            if(dateIn || !hasText) { 
                const dateStr = dateIn ? dateIn : "2025";
                const dateOp = dateIn ? GLOBAL_OPACITY : 0.3;
                const dateSize = TYPO_CONFIG.baseDetails * state.ppi * state.text.scale;
                
                const dObj = new fabric.Text(dateStr, {
                    fontFamily: state.text.font, fontSize: dateSize,
                    fill: txtColor, opacity: dateOp,
                    originX: 'center', originY: 'top',
                    top: tObj.height/2 + (compact ? 1.0 : 2.0)*state.ppi 
                });
                group.addWithUpdate(dObj);
            }
            return group;
        }

        function renderTextBlock(x, y, compact) {
            const group = createTextBlockObj(compact);
            group.set({ left: x, top: y });
            canvas.add(group);
        }

        function renderIcon(x, y, forcedSize = null) {
            let iconUrl = state.images.icon;
            let isGhost = false;
            
            if(!iconUrl) {
                iconUrl = 'assets/preview/icons/love/01heart.png';
                isGhost = true;
            }

            let size = forcedSize;
            if(!size) {
                size = (2.0 / 1.6) * state.ppi * state.text.scale; 
            }
            
            fabric.Image.fromURL(iconUrl, (img) => {
                if(!img) return;
                img.scaleToWidth(size);
                img.set({ left: x, top: y, originX: 'center', originY: 'center', selectable: false });
                
                const opacity = isGhost ? 0.3 : GLOBAL_OPACITY; 
                img.set({ opacity: opacity });

                const filter = new fabric.Image.filters.BlendColor({ color: state.text.color, mode: 'tint', alpha: 1 });
                img.filters.push(filter); img.applyFilters();
                canvas.add(img);
            });
        }

        function renderImageSlot(x, y) {
            const w = state.slotSize.w * state.ppi; const h = state.slotSize.h * state.ppi;
            if(state.images.main && state.images.main.src) {
                fabric.Image.fromURL(state.images.main.src, (img) => {
                    const info = state.images.main.cropInfo; const scaleFactor = w / info.slotPixelSize;
                    img.set({ scaleX: info.scale * scaleFactor, scaleY: info.scale * scaleFactor, left: x + (info.left * scaleFactor), top: y + (info.top * scaleFactor), originX: 'center', originY: 'center', selectable: false, clipPath: new fabric.Rect({ width: w * (1/(info.scale * scaleFactor)), height: h * (1/(info.scale * scaleFactor)), left: -(info.left * scaleFactor) / (info.scale * scaleFactor), top: -(info.top * scaleFactor) / (info.scale * scaleFactor), originX: 'center', originY: 'center' }) });
                    if (state.layout === 'graphic') { 
                        img.set({ opacity: GLOBAL_OPACITY });
                        const filter = new fabric.Image.filters.BlendColor({ color: state.text.color, mode: 'tint', alpha: 1 }); 
                        img.filters.push(filter); img.applyFilters(); 
                    }
                    canvas.add(img);
                });
            } else {
                const rect = new fabric.Rect({ width: w, height: h, fill: 'transparent', stroke: '#ddd', strokeWidth:2, strokeDashArray: [20,20], left: x, top: y, originX: 'center', originY: 'center', selectable: false, opacity: GLOBAL_OPACITY });
                canvas.add(rect); canvas.add(new fabric.Text(state.layout === 'graphic' ? "ART" : "PHOTO", { fontSize: 0.3*state.ppi, fontFamily:'Tenor Sans', left: x, top: y, originX: 'center', originY: 'center', fill: '#bbb', selectable: false, opacity: GLOBAL_OPACITY }));
            }
        }

        // --- HANDLERS (UPDATED) ---
        // Inputs now use oninput to rerender instantly
        ['inputLine1','inputLine2','inputLine3','dateLine', 'spineInput', 'copyrightInput'].forEach(id => {
            document.getElementById(id).oninput = (e) => {
                if(id === 'copyrightInput') state.text.copyright = e.target.value;
                else if(id === 'spineInput') state.text.spine = e.target.value;
                renderLayout();
            };
        });
        document.getElementById('fontSelector').addEventListener('change', (e) => { state.text.font = e.target.value; renderLayout(); });
        document.getElementById('textScale').oninput = (e) => { state.text.scale = parseFloat(e.target.value); renderLayout(); };

        document.getElementById('iconLoader').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => { state.images.icon = ev.target.result; updateSymbolUI(); renderLayout(); }; if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); };
        document.getElementById('uploadImageBtn').onclick = () => document.getElementById('imageLoader').click();
        document.getElementById('imageLoader').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => openCropper(ev.target.result); if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); e.target.value = ''; };

        // Gallery & Others... (Unchanged)
        let curGalTarget = 'main'; 
        window.openGallery = (type, target) => {
            curGalTarget = target;
            document.getElementById('galleryModal').classList.remove('hidden');
            const tabs = document.getElementById('galleryTabs'); tabs.innerHTML = '';
            const db = type === 'icons' ? ASSETS_DB.icons : ASSETS_DB.graphics;
            Object.keys(db).forEach((cat, i) => {
                const t = document.createElement('div'); t.className = `gallery-tab ${i===0?'active':''}`; t.innerText = cat;
                t.onclick = () => { document.querySelectorAll('.gallery-tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); loadGal(type, cat); };
                tabs.appendChild(t);
            });
            if(Object.keys(db).length) loadGal(type, Object.keys(db)[0]);
        }
        
        function loadGal(type, cat) {
            const grid = document.getElementById('galleryGrid');
            const files = (type === 'icons' ? ASSETS_DB.icons : ASSETS_DB.graphics)[cat] || [];
            grid.innerHTML = '';
            for(let f of files) {
                const item = document.createElement('div'); item.className = 'gallery-item';
                const img = document.createElement('img');
                const relPath = `${type}/${cat.toLowerCase()}/${f}`;
                const previewUrl = 'assets/preview/' + relPath;
                const printUrl = 'assets/print/' + relPath;
                img.src = previewUrl; img.onerror = () => { img.src = printUrl; };
                item.appendChild(img);
                item.onclick = () => {
                    loadSimpleImage(printUrl, (url1) => {
                        let finalUrl = url1 || previewUrl;
                        document.getElementById('galleryModal').classList.add('hidden'); 
                        
                        if(curGalTarget === 'global') {
                            state.images.icon = finalUrl;
                            updateSymbolUI();
                            renderLayout();
                        } else {
                            if(type==='icons') { /* Fallback */ } 
                            else openCropper(finalUrl); 
                        }
                    });
                };
                grid.appendChild(item);
            }
        }
        window.closeGallery = () => document.getElementById('galleryModal').classList.add('hidden');

        function initCrop() { if(!cropCanvas) { cropCanvas = new fabric.Canvas('cropCanvas', { width: CROP_CANVAS_SIZE, height: CROP_CANVAS_SIZE, backgroundColor: '#111', selection: false }); } cropCanvas.clear(); cropCanvas.setBackgroundColor('#111'); }
        function openCropper(url) {
            document.getElementById('cropperModal').classList.remove('hidden'); initCrop();
            const aspect = state.slotSize.w / state.slotSize.h;
            let slotPW, slotPH; if(aspect >= 1) { slotPW = CROP_CANVAS_SIZE*0.8; slotPH = slotPW/aspect; } else { slotPH = CROP_CANVAS_SIZE*0.8; slotPW = slotPH*aspect; }
            activeCropSlot = { w: slotPW, h: slotPH };
            fabric.Image.fromURL(url, (img) => {
                tempImgObject = img;
                const scale = Math.max(slotPW/img.width, slotPH/img.height);
                img.set({ left: CROP_CANVAS_SIZE/2, top: CROP_CANVAS_SIZE/2, originX: 'center', originY: 'center', scaleX: scale, scaleY: scale, hasControls: false, hasBorders: false });
                cropCanvas.add(img);
                const cx = CROP_CANVAS_SIZE/2, cy = CROP_CANVAS_SIZE/2;
                const overlay = new fabric.Path(`M 0 0 H ${CROP_CANVAS_SIZE} V ${CROP_CANVAS_SIZE} H 0 Z M ${cx-slotPW/2} ${cy-slotPH/2} H ${cx+slotPW/2} V ${cy+slotPH/2} H ${cx-slotPW/2} Z`, { fill: 'rgba(0,0,0,0.8)', selectable: false, evented: false });
                cropCanvas.add(overlay);
                const border = new fabric.Rect({ left: cx, top: cy, width: slotPW, height: slotPH, fill: 'transparent', stroke: '#fff', strokeWidth: 1, originX: 'center', originY: 'center', selectable: false, evented: false });
                cropCanvas.add(border);
                const slider = document.getElementById('zoomSlider'); slider.min = scale*0.5; slider.max = scale*4; slider.value = scale;
                slider.oninput = function() { img.scale(parseFloat(this.value)); cropCanvas.requestRenderAll(); };
            });
        }
        document.getElementById('applyCropBtn').onclick = () => {
            if(!tempImgObject) return;
            const offX = tempImgObject.left - CROP_CANVAS_SIZE/2; const offY = tempImgObject.top - CROP_CANVAS_SIZE/2;
            state.images.main = { src: tempImgObject.getSrc(), cropInfo: { left: offX, top: offY, scale: tempImgObject.scaleX, slotPixelSize: activeCropSlot.w } };
            renderLayout(); document.getElementById('cropperModal').classList.add('hidden');
        };
        document.getElementById('cancelCropBtn').onclick = () => document.getElementById('cropperModal').classList.add('hidden');

        document.getElementById('saveBtn').onclick = () => {
            try {
                const mult = (EXPORT_DPI / CM_TO_INCH) / state.ppi;
                canvas.getObjects('line').forEach(o => o.opacity = 0);
                const data = canvas.toDataURL({ format: 'png', multiplier: mult, quality: 1 });
                canvas.getObjects('line').forEach(o => o.opacity = 0.3);
                const a = document.createElement('a'); a.download = `cover_${state.bookSize}cm.png`; a.href = data; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            } catch(e) { alert("Ошибка сохранения: Браузер блокирует доступ (CORS)."); }
        };

        window.onload = loadDefaultAssets;
        window.addEventListener('resize', () => setTimeout(updateCanvasDimensions, 100));
    </script>
</body>
</html>